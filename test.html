<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Quản Lý & Shop Bán Hàng</title>
    <!-- Remix Icon -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet"/>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --primary-color: #0d6efd; --success-color: #198754; --danger-color: #dc3545; --warning-color: #ffc107; --info-color: #0dcaf0; --secondary-color: #6c757d; --light-gray: #f8f9fa; --border-color: #dee2e6; --shop-bg: #f3f4f6; }
        
        /* --- Cài đặt chung --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: var(--light-gray); color: #333; line-height: 1.6; }
        .container { max-width: 1400px; margin: 20px auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,0.08); min-height: 90vh; }
        .grid-container { display: grid; grid-template-columns: 1fr; gap: 30px; }
        @media (min-width: 992px) { .grid-container { grid-template-columns: repeat(2, 1fr); } }

        /* --- Icons & Inputs --- */
        i { vertical-align: middle; }
        input, select, button { padding: 12px 15px; margin: 8px 0; width: 100%; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; font-size: 16px; transition: all 0.2s ease-in-out; }
        input:focus, select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25); outline: none; }
        button { color: white; cursor: pointer; border: none; font-weight: 500; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: opacity 0.2s; }
        button:hover:not(:disabled) { opacity: 0.85; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* --- Auth --- */
        #auth-container { max-width: 420px; margin: 50px auto; padding: 30px; border: 1px solid var(--border-color); border-radius: 12px; background: #fff; }
        .auth-form h2 { text-align: center; margin-bottom: 25px; color: var(--primary-color); }
        #register-form { display: none; }
        .form-toggle-link { color: var(--primary-color); text-decoration: none; cursor: pointer; display: block; margin-top: 15px; text-align: center; }
        .error-message { color: var(--danger-color); text-align: center; margin-top: 10px; min-height: 1em; }

        /* --- Main App Navigation --- */
        #app { display: none; }
        .app-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; }
        .view-switcher { display: flex; gap: 10px; background: #eee; padding: 5px; border-radius: 8px; }
        .view-btn { padding: 10px 20px; border-radius: 6px; cursor: pointer; border: none; background: transparent; color: #555; font-weight: 600; width: auto; margin: 0; }
        .view-btn.active { background: white; color: var(--primary-color); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* --- Dashboard Styles --- */
        h1, h2, h3 { color: #343a40; }
        h1 { display: flex; align-items: center; gap: 12px;}
        h2 { border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-top: 40px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-size: 1.5em;}
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid var(--border-color); padding: 14px; text-align: left; vertical-align: middle;}
        th { background-color: var(--light-gray); font-weight: 600; }
        tbody tr:hover { background-color: #f5f5f5; }
        .main-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; }
        .stat-item { background-color: var(--light-gray); padding: 20px; border-radius: 8px; border-left: 5px solid; position: relative; overflow: hidden; }
        .stat-item strong { font-size: 1.7em; color: #000; display: block; margin-top: 5px; }
        .stat-profit { border-color: var(--success-color); } .stat-revenue { border-color: var(--primary-color); }
        .stat-cost { border-color: var(--warning-color); } .stat-info { border-color: var(--info-color); }

        /* --- SHOP MODE STYLES (NEW) --- */
        #shop-view { display: none; background-color: var(--shop-bg); margin: -30px; padding: 30px; border-radius: 12px; min-height: 80vh; }
        .shop-toolbar { display: flex; gap: 20px; margin-bottom: 25px; align-items: center; flex-wrap: wrap; background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .shop-search { flex-grow: 1; margin: 0; }
        .shop-categories { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; width: 100%; scrollbar-width: none; }
        .category-chip { white-space: nowrap; padding: 8px 16px; background: #e9ecef; border-radius: 20px; cursor: pointer; transition: 0.3s; font-weight: 500; user-select: none; }
        .category-chip:hover { background: #dee2e6; }
        .category-chip.active { background: var(--primary-color); color: white; }
        
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        .product-card { background: white; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; justify-content: space-between; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative; overflow: hidden; border: 1px solid transparent; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); border-color: var(--primary-color); }
        .product-icon { font-size: 3em; color: var(--primary-color); opacity: 0.2; align-self: center; margin-bottom: 15px; }
        .product-name { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; line-height: 1.3; color: #333; }
        .product-code { font-size: 0.85em; color: #777; margin-bottom: 10px; }
        .product-price { font-size: 1.2em; color: var(--danger-color); font-weight: bold; margin-bottom: 15px; }
        .product-stock { font-size: 0.9em; color: var(--success-color); margin-bottom: 15px; display: block; }
        .product-stock.out { color: var(--danger-color); }
        .add-to-cart-btn { width: 100%; background: var(--primary-color); border-radius: 8px; padding: 10px; margin: 0; }
        
        .shop-cart-btn { position: fixed; bottom: 30px; right: 30px; background: var(--danger-color); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4); cursor: pointer; z-index: 900; transition: transform 0.2s; }
        .shop-cart-btn:hover { transform: scale(1.1); }
        .cart-badge { position: absolute; top: -5px; right: -5px; background: #fff; color: var(--danger-color); border: 2px solid var(--danger-color); font-size: 12px; font-weight: bold; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        /* --- Modals --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .modal-content { background-color: #fefefe; padding: 30px; border: 1px solid #888; width: 100%; max-width: 550px; border-radius: 10px; animation: slide-down 0.4s ease-out; position: relative; }
        .modal-content.large { max-width: 1100px; }
        .modal-body { max-height: 78vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 25px; }
        .close { color: #aaa; font-size: 32px; font-weight: bold; cursor: pointer; line-height: 1; }
        @keyframes slide-down { from { transform: translateY(-40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* --- Loader & Toast --- */
        #loader { display: flex; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.85); justify-content: center; align-items: center; flex-direction: column; gap: 15px; font-size: 1.2em; opacity: 1; transition: opacity 0.3s; }
        #loader.hidden { opacity: 0; pointer-events: none; }
        .spinner { width: 50px; height: 50px; border-radius: 50%; border-top: 5px solid var(--primary-color); border-right: 5px solid transparent; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
        .toast { display: flex; align-items: center; gap: 15px; padding: 15px 20px; border-radius: 8px; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideIn 0.5s, slideOut 0.5s 4.5s forwards; min-width: 300px; }
        .toast.success { background-color: var(--success-color); } .toast.error { background-color: var(--danger-color); } .toast.info { background-color: var(--primary-color); }
        @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
        @keyframes slideOut { to { transform: translateX(120%); opacity: 0; } }

        /* Tabs */
        .tabs { display: flex; border-bottom: 2px solid #ccc; margin-bottom: 20px; }
        .tab-link { padding: 12px 25px; cursor: pointer; background: #f1f1f1; border: 1px solid #ccc; border-bottom: none; margin-bottom: -2px; border-radius: 6px 6px 0 0; display: flex; align-items: center; gap: 8px;}
        .tab-link.active { background: #fff; border-bottom: 2px solid #fff; font-weight: bold; color: var(--primary-color);}
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<!-- TOAST & LOADER -->
<div id="toast-container"></div>
<div id="loader" class="hidden"><div class="spinner"></div><p>Đang tải dữ liệu...</p></div>

<div class="container">
    <!-- LOGIN/REGISTER -->
    <div id="auth-container">
        <form id="login-form" class="auth-form"><h2><i class="ri-login-box-line"></i> Đăng Nhập</h2><input type="email" id="login-email" placeholder="Email" required><input type="password" id="login-password" placeholder="Mật khẩu" required><button type="submit" style="background-color: var(--primary-color);">Đăng Nhập</button><p id="login-error" class="error-message"></p><span id="show-register" class="form-toggle-link">Chưa có tài khoản? Đăng ký</span></form>
        <form id="register-form" class="auth-form"><h2><i class="ri-user-add-line"></i> Đăng Ký</h2><input type="email" id="register-email" placeholder="Email" required><input type="password" id="register-password" placeholder="Mật khẩu (>6 ký tự)" required><button type="submit" style="background-color: var(--info-color);">Đăng Ký</button><p id="register-error" class="error-message"></p><span id="show-login" class="form-toggle-link">Đã có tài khoản? Đăng nhập</span></form>
    </div>

    <!-- MAIN APP -->
    <div id="app">
        <!-- HEADER & NAVIGATION -->
        <div class="app-header">
            <div id="user-info">Xin chào, <strong id="user-email"></strong> <button id="logout-button" style="background-color:var(--secondary-color); width:auto; font-size: 12px; padding: 5px 10px; margin-left: 10px;"><i class="ri-logout-box-r-line"></i></button></div>
            <div class="view-switcher">
                <button class="view-btn active" onclick="switchView('dashboard')"><i class="ri-dashboard-line"></i> Quản Lý</button>
                <button class="view-btn" onclick="switchView('shop')"><i class="ri-store-2-line"></i> Cửa Hàng</button>
            </div>
        </div>

        <!-- 1. DASHBOARD VIEW (Original System) -->
        <div id="dashboard-view">
            <h1><i class="ri-dashboard-fill"></i> Bảng Điều Khiển</h1>
            <div class="main-actions">
                <button onclick="openModal('sales-modal')" style="background-color: var(--primary-color);"><i class="ri-shopping-cart-2-line"></i> Tạo Đơn Hàng</button>
                <button onclick="openModal('inventory-modal')" style="background-color: var(--secondary-color);"><i class="ri-archive-line"></i> Quản Lý Kho</button>
                <button onclick="openModal('history-modal')" style="background-color: var(--info-color);"><i class="ri-history-line"></i> Lịch Sử Giao Dịch</button>
                <button onclick="openModal('revenue-report-modal')" style="background-color: var(--warning-color);"><i class="ri-line-chart-line"></i> Báo Cáo Doanh Thu</button>
            </div>

            <h2><i class="ri-numbers-line"></i> Thống Kê Nhanh</h2>
            <div class="stats-grid">
                <div class="stat-item stat-info"><p>Đơn hôm nay</p><strong id="daily-orders">0</strong></div>
                <div class="stat-item stat-profit"><p>Lợi nhuận tổng</p><strong id="total-profit">0 đ</strong></div>
                <div class="stat-item stat-revenue"><p>Doanh thu tổng</p><strong id="total-revenue">0 đ</strong></div>
                <div class="stat-item stat-cost"><p>Giá trị kho</p><strong id="inventory-value">0 đ</strong></div>
            </div>

            <div class="grid-container" style="margin-top: 30px;">
                <div class="management-section">
                    <h2><i class="ri-settings-3-line"></i> Quản lý & Cài đặt</h2>
                    <button onclick="openModal('staff-modal')" style="background-color: #6610f2;"><i class="ri-user-settings-line"></i> Quản lý Nhân Viên</button>
                    <button onclick="openModal('category-modal')" style="background-color: #d63384; margin-top: 10px;"><i class="ri-folders-line"></i> Quản lý Danh mục</button>
                </div>
                <div class="management-section">
                    <h2><i class="ri-bank-card-line"></i> Cấu hình VietQR</h2>
                    <form id="payment-info-form">
                        <input type="text" id="beneficiary-name" placeholder="Tên chủ tài khoản" required>
                        <input type="text" id="account-number" placeholder="Số tài khoản" required>
                        <select id="bank-select" required><option value="">Đang tải ngân hàng...</option></select>
                        <button type="submit" style="background-color: var(--primary-color);">Lưu Thông Tin</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 2. SHOP VIEW (New Feature) -->
        <div id="shop-view">
            <div class="shop-toolbar">
                <input type="text" id="shop-search" class="shop-search" placeholder="Tìm kiếm sản phẩm..." oninput="renderShop()">
                <div class="shop-categories" id="shop-category-list">
                    <!-- Categories will be injected here -->
                </div>
            </div>
            
            <div class="product-grid" id="shop-product-grid">
                <!-- Products will be injected here -->
            </div>

            <!-- Floating Cart Button -->
            <div class="shop-cart-btn" onclick="openShopCart()">
                <i class="ri-shopping-cart-fill"></i>
                <div class="cart-badge" id="cart-count">0</div>
            </div>
        </div>
    </div>
</div>

<!-- ================= MODALS ================= -->

<!-- Shop Cart Modal (New) -->
<div id="shop-cart-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h2><i class="ri-shopping-basket-line"></i> Giỏ Hàng Của Bạn</h2><span class="close">&times;</span></div>
        <div class="modal-body">
            <div id="shop-cart-empty-msg" style="text-align: center; padding: 20px; color: #777;">Giỏ hàng đang trống</div>
            <div id="shop-cart-items-container">
                <table id="shop-cart-table" style="margin-top:0;"><thead><tr><th>Sản phẩm</th><th>SL</th><th>Giá</th><th>Xóa</th></tr></thead><tbody id="shop-cart-body"></tbody></table>
                <p style="text-align: right; font-size: 1.2em; margin-top: 15px;">Tổng cộng: <strong id="shop-cart-total" style="color: var(--danger-color);">0 đ</strong></p>
                
                <hr style="margin: 20px 0; border: 0; border-top: 1px dashed #ccc;">
                <h3>Thông tin thanh toán</h3>
                <input type="text" id="shop-customer-name" placeholder="Tên khách hàng (Bắt buộc)">
                <input type="tel" id="shop-customer-phone" placeholder="Số điện thoại (Bắt buộc)">
                <select id="shop-payment-method"><option value="Tiền mặt">Tiền mặt</option><option value="Chuyển khoản">Chuyển khoản (QR Code)</option></select>
                <button onclick="processShopCheckout()" style="background-color: var(--primary-color); margin-top: 10px;"><i class="ri-secure-payment-line"></i> Xác Nhận Đặt Hàng</button>
            </div>
        </div>
    </div>
</div>

<!-- (Giữ nguyên các Modal quản lý cũ của bạn: Inventory, Sales, Import, History, Staff, Category...) -->
<!-- Inventory Modal -->
<div id="inventory-modal" class="modal"><div class="modal-content large"><div class="modal-header"><h2>Quản lý Kho Hàng</h2><span class="close">&times;</span></div><div class="modal-body"><div class="modal-actions"><button onclick="openModal('import-goods-modal')" style="background-color: var(--success-color);">Nhập Hàng Mới</button><button onclick="exportInventory()" style="background-color: #1D6F42; width: auto;">Xuất Excel</button></div><input type="text" id="inventory-search-input" placeholder="Tìm kiếm..."><div style="overflow-x: auto;"><table><thead><tr><th>Tên SP</th><th>Giá bán</th><th>Danh mục</th><th>Tồn kho</th><th>Hành động</th></tr></thead><tbody id="inventory-list-table"></tbody></table></div></div></div></div>

<!-- Sales Modal (Admin) -->
<div id="sales-modal" class="modal"><div class="modal-content large"><div class="modal-header"><h2>Tạo Đơn Hàng (Admin)</h2><span class="close">&times;</span></div><div class="modal-body"><form id="sales-form"><input type="tel" id="customer-phone" placeholder="SĐT Khách" required><input type="text" id="customer-name" placeholder="Tên Khách"><div style="display:flex; gap:10px;"><select id="sales-category-select"></select><select id="sales-product-select"></select><button type="button" id="add-to-cart-btn" style="width:auto;">Thêm</button></div><table><thead><tr><th>SP</th><th>SL</th><th>Tiền</th><th>Xóa</th></tr></thead><tbody id="sales-cart-items"></tbody></table><select id="sales-staff" required><option value="">-- Nhân viên --</option></select><select id="payment-method"><option value="Tiền mặt">Tiền mặt</option><option value="Chuyển khoản">Chuyển khoản</option></select><p>Tổng: <span id="sales-total">0 đ</span></p><button type="submit">Thanh Toán</button></form></div></div></div>

<!-- Import Modal -->
<div id="import-goods-modal" class="modal"><div class="modal-content large"><div class="modal-header"><h2>Nhập Hàng</h2><span class="close">&times;</span></div><div class="modal-body"><form id="import-form"><select id="import-category-select"></select><select id="import-product-select"><option value="new">-- Sản phẩm mới --</option></select><div id="new-product-fields" style="display:none"><input type="text" id="new-product-name" placeholder="Tên SP"><input type="number" id="new-import-price" placeholder="Giá nhập"><input type="number" id="new-sell-price" placeholder="Giá bán"></div><input type="number" id="import-quantity-input" placeholder="Số lượng"><button type="button" id="add-to-import-list-btn">Thêm dòng</button><table><tbody id="import-list-table"></tbody></table><button type="submit" id="confirm-import-btn">Nhập Kho</button></form></div></div></div>

<!-- Staff Modal -->
<div id="staff-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Nhân viên</h2><span class="close">&times;</span></div><div class="modal-body"><form id="add-staff-form"><input type="hidden" id="staff-id"><input type="text" id="staff-name" placeholder="Tên NV"><input type="number" id="staff-commission" placeholder="Hoa hồng %"><button type="submit">Lưu</button></form><table><tbody id="staff-list-table"></tbody></table></div></div></div>

<!-- Category Modal -->
<div id="category-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Danh mục</h2><span class="close">&times;</span></div><div class="modal-body"><form id="add-category-form"><input type="text" id="category-name" placeholder="Tên danh mục"><button type="submit">Thêm</button></form><table><tbody id="category-list-table"></tbody></table></div></div></div>

<!-- History Modal -->
<div id="history-modal" class="modal"><div class="modal-content large"><div class="modal-header"><h2>Lịch sử</h2><span class="close">&times;</span></div><div class="modal-body"><div class="tabs"><div class="tab-link active" onclick="openTab(event, 'export-history')">Xuất hàng</div><div class="tab-link" onclick="openTab(event, 'import-history')">Nhập hàng</div></div><div id="export-history" class="tab-content active"><table><tbody id="export-history-table"></tbody></table></div><div id="import-history" class="tab-content"><table><tbody id="import-history-table"></tbody></table></div></div></div></div>

<!-- Revenue Report Modal -->
<div id="revenue-report-modal" class="modal"><div class="modal-content large"><div class="modal-header"><h2>Báo Cáo Doanh Thu</h2><span class="close">&times;</span></div><div class="modal-body"><form id="revenue-report-form" style="display:flex; gap:10px;"><input type="date" id="start-date"><input type="date" id="end-date"><button type="submit">Xem</button></form><canvas id="revenue-chart" style="max-height:400px; margin-top:20px;"></canvas><div id="report-summary-stats"></div></div></div></div>

<!-- Edit Product Modal -->
<div id="edit-product-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2>Sửa Sản Phẩm</h2><span class="close">&times;</span></div><div class="modal-body"><form id="edit-product-form"><input type="hidden" id="edit-product-id"><input type="text" id="edit-product-name"><input type="number" id="edit-import-price"><input type="number" id="edit-sell-price"><select id="edit-category"></select><button type="submit">Lưu</button></form></div></div></div>

<!-- QR Modal -->
<div id="qr-confirm-modal" class="modal"><div class="modal-content" style="text-align:center;"><div class="modal-header"><h2>Quét mã VietQR</h2><span class="close">&times;</span></div><div class="modal-body"><img id="qr-code-image" src="" style="max-width:100%; border-radius:8px;"><p id="qr-content" style="margin-top:10px; font-weight:bold;"></p><button id="confirm-payment-btn" style="background-color:var(--success-color); margin-top:15px;">Đã Nhận Tiền & Hoàn Tất</button></div></div></div>

<!-- Firebase Config -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<script>
    // --- FIREBASE CONFIG (Giữ nguyên) ---
    const firebaseConfig = { apiKey: "AIzaSyCHjgJkqVmgpZ6s5HRobpqB6XT--Sa2_zY", authDomain: "tgapp-30a28.firebaseapp.com", projectId: "tgapp-30a28", storageBucket: "tgapp-30a28.firebasestorage.app", messagingSenderId: "329047273664", appId: "1:329047273664:web:c9e1bfe367afb54953fd25", measurementId: "G-68P4PT49B0" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- VARIABLES ---
    let allProducts = [], allTransactions = [], allCategories = [], allStaff = [], allCustomers = [], paymentInfo = null;
    let shopCart = []; // Giỏ hàng của chế độ Shop
    let currentOrderItems = [], currentImportItems = [], tempOrderData = null, revenueChartInstance = null;
    let activeCategory = 'all'; // Danh mục đang chọn ở Shop

    // --- UTILS ---
    const loader = document.getElementById('loader');
    const showLoader = () => { loader.classList.remove('hidden'); };
    const hideLoader = () => { loader.classList.add('hidden'); };
    const formatCurrency = (n) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(n || 0);
    const showToast = (msg, type = 'info') => {
        const t = document.createElement('div'); t.className = `toast ${type}`; t.innerText = msg;
        document.getElementById('toast-container').appendChild(t); setTimeout(() => t.remove(), 5000);
    };

    // --- AUTH ---
    auth.onAuthStateChanged(u => {
        if(u) {
            document.getElementById('auth-container').style.display='none';
            document.getElementById('app').style.display='block';
            document.getElementById('user-email').textContent = u.email;
            loadData();
        } else {
            document.getElementById('auth-container').style.display='block';
            document.getElementById('app').style.display='none';
            hideLoader();
        }
    });
    document.getElementById('logout-button').onclick = () => auth.signOut();
    document.getElementById('login-form').onsubmit = (e) => { e.preventDefault(); showLoader(); auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value).catch(err => { hideLoader(); document.getElementById('login-error').innerText = err.message; }); };
    document.getElementById('register-form').onsubmit = (e) => { e.preventDefault(); showLoader(); auth.createUserWithEmailAndPassword(document.getElementById('register-email').value, document.getElementById('register-password').value).catch(err => { hideLoader(); document.getElementById('register-error').innerText = err.message; }); };
    document.getElementById('show-register').onclick = () => { document.getElementById('login-form').style.display='none'; document.getElementById('register-form').style.display='block'; };
    document.getElementById('show-login').onclick = () => { document.getElementById('register-form').style.display='none'; document.getElementById('login-form').style.display='block'; };

    // --- MAIN DATA LOADING ---
    async function loadData() {
        showLoader();
        try {
            const [p, t, c, s, cust, pay] = await Promise.all([
                db.collection('products').get(), db.collection('transactions').orderBy('timestamp', 'desc').get(), db.collection('categories').get(), db.collection('staff').get(), db.collection('customers').get(), db.collection('settings').doc('paymentInfo').get()
            ]);
            allProducts = p.docs.map(d => ({id: d.id, ...d.data()}));
            allTransactions = t.docs.map(d => ({id: d.id, ...d.data()}));
            allCategories = c.docs.map(d => ({id: d.id, ...d.data()}));
            allStaff = s.docs.map(d => ({id: d.id, ...d.data()}));
            allCustomers = cust.docs.map(d => ({id: d.id, ...d.data()}));
            paymentInfo = pay.exists ? pay.data() : null;

            updateDashboard();
            renderShop(); // Render Shop ngay khi có dữ liệu
            populateDropdowns();
            loadPaymentInfo();
        } catch(e) { console.error(e); showToast("Lỗi tải dữ liệu", "error"); }
        hideLoader();
    }

    // --- NAVIGATION & TABS ---
    window.switchView = (viewId) => {
        document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('#app > div[id$="-view"]').forEach(d => d.style.display = 'none');
        document.getElementById(`${viewId}-view`).style.display = 'block';
        event.currentTarget.classList.add('active');
        if(viewId === 'shop') renderShop();
    };

    // --- SHOP LOGIC (NEW) ---
    function renderShop() {
        const grid = document.getElementById('shop-product-grid');
        const catList = document.getElementById('shop-category-list');
        const search = document.getElementById('shop-search').value.toLowerCase();

        // 1. Render Categories Chips
        let catHTML = `<div class="category-chip ${activeCategory==='all'?'active':''}" onclick="setShopCategory('all')">Tất cả</div>`;
        allCategories.forEach(c => {
            catHTML += `<div class="category-chip ${activeCategory===c.name?'active':''}" onclick="setShopCategory('${c.name}')">${c.name}</div>`;
        });
        catList.innerHTML = catHTML;

        // 2. Filter Products
        let filtered = allProducts.filter(p => {
            const matchCat = activeCategory === 'all' || p.category === activeCategory;
            const matchSearch = p.name.toLowerCase().includes(search) || (p.code && p.code.toLowerCase().includes(search));
            return matchCat && matchSearch;
        });

        // 3. Render Grid
        grid.innerHTML = filtered.map(p => {
            const isOut = p.inventory <= 0;
            return `
            <div class="product-card">
                <div class="product-icon"><i class="ri-shopping-bag-3-line"></i></div>
                <div class="product-name">${p.name}</div>
                <div class="product-code">${p.code || ''}</div>
                <div class="product-stock ${isOut?'out':''}">${isOut ? 'Hết hàng' : 'Sẵn có: ' + p.inventory}</div>
                <div class="product-price">${formatCurrency(p.sellPrice)}</div>
                <button class="add-to-cart-btn" onclick="addToShopCart('${p.id}')" ${isOut?'disabled':''} style="background:${isOut?'#ccc':'var(--primary-color)'}">
                    ${isOut ? 'Hết hàng' : '<i class="ri-add-shopping-cart-line"></i> Thêm vào giỏ'}
                </button>
            </div>
            `;
        }).join('');
    }

    window.setShopCategory = (cat) => { activeCategory = cat; renderShop(); };

    window.addToShopCart = (id) => {
        const p = allProducts.find(x => x.id === id);
        if(!p || p.inventory <= 0) return showToast('Sản phẩm hết hàng', 'error');
        
        const existing = shopCart.find(x => x.id === id);
        if(existing) {
            if(existing.qty < p.inventory) { existing.qty++; showToast('Đã tăng số lượng'); }
            else showToast('Đã đạt giới hạn tồn kho', 'warning');
        } else {
            shopCart.push({...p, qty: 1});
            showToast('Đã thêm vào giỏ', 'success');
        }
        updateShopCartBadge();
    };

    function updateShopCartBadge() {
        document.getElementById('cart-count').innerText = shopCart.reduce((sum, i) => sum + i.qty, 0);
    }

    window.openShopCart = () => {
        const body = document.getElementById('shop-cart-body');
        const totalEl = document.getElementById('shop-cart-total');
        const container = document.getElementById('shop-cart-items-container');
        const emptyMsg = document.getElementById('shop-cart-empty-msg');

        if(shopCart.length === 0) {
            container.style.display = 'none'; emptyMsg.style.display = 'block';
        } else {
            container.style.display = 'block'; emptyMsg.style.display = 'none';
            let total = 0;
            body.innerHTML = shopCart.map((item, idx) => {
                const sub = item.qty * item.sellPrice;
                total += sub;
                return `<tr>
                    <td>${item.name}</td>
                    <td><button onclick="changeShopQty(${idx}, -1)" style="width:25px;padding:2px">-</button> ${item.qty} <button onclick="changeShopQty(${idx}, 1)" style="width:25px;padding:2px">+</button></td>
                    <td>${formatCurrency(sub)}</td>
                    <td><button onclick="shopCart.splice(${idx}, 1); openShopCart(); updateShopCartBadge()" style="background:var(--danger-color); padding:5px;"><i class="ri-delete-bin-line"></i></button></td>
                </tr>`;
            }).join('');
            totalEl.innerText = formatCurrency(total);
        }
        openModal('shop-cart-modal');
    };

    window.changeShopQty = (idx, delta) => {
        const item = shopCart[idx];
        const p = allProducts.find(x => x.id === item.id);
        const newQty = item.qty + delta;
        if(newQty > 0 && newQty <= p.inventory) { item.qty = newQty; openShopCart(); updateShopCartBadge(); }
        else if(newQty <= 0) { shopCart.splice(idx, 1); openShopCart(); updateShopCartBadge(); }
        else { showToast('Không đủ tồn kho', 'warning'); }
    };

    window.processShopCheckout = async () => {
        const name = document.getElementById('shop-customer-name').value.trim();
        const phone = document.getElementById('shop-customer-phone').value.trim();
        if(!name || !phone) return showToast('Vui lòng nhập tên và SĐT', 'error');
        
        const method = document.getElementById('shop-payment-method').value;
        const total = shopCart.reduce((sum, i) => sum + i.qty * i.sellPrice, 0);
        
        // Prepare data similar to sales-modal
        tempOrderData = {
            customerName: name, customerPhone: phone, staffId: 'ONLINE_SHOP', 
            items: shopCart.map(i => ({...i, quantity: i.qty, subtotal: i.qty * i.sellPrice})),
            transactionId: `SHOP${Date.now()}`
        };

        if(method === 'Chuyển khoản') {
            if (!paymentInfo) return showToast("Chưa cấu hình thanh toán", "error");
            displayVietQR(total, tempOrderData.transactionId);
        } else {
            if(confirm(`Xác nhận thanh toán ${formatCurrency(total)}?`)) await finalizeOrder();
        }
    };

    // --- SHARED CORE FUNCTIONS ---
    async function finalizeOrder() {
        showLoader();
        try {
            const { items, customerName, customerPhone, transactionId } = tempOrderData;
            
            // Update Customer
            const existCust = allCustomers.find(c => c.phone === customerPhone);
            if(!existCust) await db.collection('customers').add({name: customerName, phone: customerPhone});

            // Update Inventory
            const batch = db.batch();
            items.forEach(i => {
                const ref = db.collection('products').doc(i.id);
                batch.update(ref, { inventory: firebase.firestore.FieldValue.increment(-i.quantity) });
            });
            await batch.commit();

            // Create Transaction
            let revenue = 0, cost = 0;
            items.forEach(i => { revenue += i.subtotal; cost += i.quantity * i.importPrice; });
            
            await db.collection('transactions').add({
                type: 'export', items: items.map(i => ({productId: i.id, name: i.name, quantity: i.quantity, sellPrice: i.sellPrice})),
                totalRevenue: revenue, totalCost: cost, totalProfit: revenue - cost,
                customerName, customerPhone, staffName: 'Online Shop', transactionId,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Reset
            shopCart = []; updateShopCartBadge();
            closeAllModals();
            showToast('Đặt hàng thành công!', 'success');
            loadData();
        } catch(e) { console.error(e); showToast('Lỗi thanh toán: ' + e.message, 'error'); }
        hideLoader();
    }

    function displayVietQR(amount, orderId) {
        if(!paymentInfo) return;
        const { bankBin, accountNumber, beneficiaryName } = paymentInfo;
        const addInfo = `TT ${orderId}`;
        const url = `https://img.vietqr.io/image/${bankBin}-${accountNumber}-compact2.jpg?amount=${amount}&addInfo=${encodeURIComponent(addInfo)}&accountName=${encodeURIComponent(beneficiaryName)}`;
        document.getElementById('qr-code-image').src = url;
        document.getElementById('qr-content').innerText = addInfo;
        closeModal('shop-cart-modal'); // Close shop cart
        closeModal('sales-modal'); // Close admin sales
        openModal('qr-confirm-modal');
    }

    // --- DASHBOARD FUNCTIONS (Original Logic Preserved & Minified) ---
    function updateDashboard() {
        let rev = 0, profit = 0, todayOrders = 0;
        const now = new Date(); const startDay = new Date(now.setHours(0,0,0,0));
        allTransactions.forEach(t => {
            if(t.type === 'export') {
                rev += t.totalRevenue||0; profit += t.totalProfit||0;
                if(t.timestamp && t.timestamp.toDate() >= startDay) todayOrders++;
            }
        });
        const invVal = allProducts.reduce((s, p) => s + (p.inventory||0)*(p.importPrice||0), 0);
        document.getElementById('daily-orders').innerText = todayOrders;
        document.getElementById('total-profit').innerText = formatCurrency(profit);
        document.getElementById('total-revenue').innerText = formatCurrency(rev);
        document.getElementById('inventory-value').innerText = formatCurrency(invVal);
        renderInventory(); renderStaff(); renderCategories();
    }

    // Render Tables
    function renderInventory() {
        const term = document.getElementById('inventory-search-input').value.toLowerCase();
        const tbody = document.getElementById('inventory-list-table');
        tbody.innerHTML = allProducts.filter(p => p.name.toLowerCase().includes(term)).map(p => 
            `<tr><td>${p.name}</td><td>${formatCurrency(p.sellPrice)}</td><td>${p.category}</td><td>${p.inventory}</td>
            <td><button onclick="editProduct('${p.id}')" style="background:var(--warning-color);padding:5px;"><i class="ri-pencil-line"></i></button></td></tr>`
        ).join('');
    }
    document.getElementById('inventory-search-input').oninput = renderInventory;

    function renderStaff() {
        document.getElementById('staff-list-table').innerHTML = allStaff.map(s => `<tr><td>${s.name}</td><td>${s.commissionRate}%</td></tr>`).join('');
    }
    
    function renderCategories() {
        document.getElementById('category-list-table').innerHTML = allCategories.map(c => `<tr><td>${c.name}</td></tr>`).join('');
    }

    // Modal Helpers
    window.openModal = (id) => { 
        document.querySelectorAll('.modal').forEach(m => m.style.display='none');
        document.getElementById(id).style.display='flex';
        if(id === 'sales-modal') { document.getElementById('sales-form').reset(); currentOrderItems=[]; renderSalesCart(); populateDropdowns(); }
        if(id === 'history-modal') renderHistory();
    };
    window.closeModal = (id) => document.getElementById(id).style.display='none';
    window.closeAllModals = () => document.querySelectorAll('.modal').forEach(m => m.style.display='none');
    document.querySelectorAll('.close').forEach(b => b.onclick = function() { closeModal(this.closest('.modal').id) });

    // Dropdowns
    function populateDropdowns() {
        const catSelects = ['sales-category-select', 'import-category-select', 'edit-category'];
        const opts = allCategories.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
        catSelects.forEach(id => { 
            const el = document.getElementById(id); if(el) el.innerHTML = '<option value="">-- Danh mục --</option>' + opts; 
        });
        const staffEl = document.getElementById('sales-staff');
        if(staffEl) staffEl.innerHTML = '<option value="">-- Chọn NV --</option>' + allStaff.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
    }

    // Admin Sales Logic
    document.getElementById('sales-category-select').onchange = (e) => {
        const cat = e.target.value;
        const prods = allProducts.filter(p => p.category === cat && p.inventory > 0);
        document.getElementById('sales-product-select').innerHTML = prods.map(p => `<option value="${p.id}">${p.name} (Tồn: ${p.inventory})</option>`).join('');
    };
    document.getElementById('add-to-cart-btn').onclick = () => {
        const pid = document.getElementById('sales-product-select').value;
        if(!pid) return;
        const p = allProducts.find(x => x.id === pid);
        const exists = currentOrderItems.find(x => x.id === pid);
        if(exists) exists.quantity++; else currentOrderItems.push({...p, quantity:1});
        renderSalesCart();
    };
    function renderSalesCart() {
        let total = 0;
        document.getElementById('sales-cart-items').innerHTML = currentOrderItems.map((item, idx) => {
            const sub = item.quantity * item.sellPrice; total += sub;
            return `<tr><td>${item.name}</td><td>${item.quantity}</td><td>${formatCurrency(sub)}</td><td><button type="button" onclick="currentOrderItems.splice(${idx},1);renderSalesCart()">X</button></td></tr>`;
        }).join('');
        document.getElementById('sales-total').innerText = formatCurrency(total);
    }
    document.getElementById('sales-form').onsubmit = async (e) => {
        e.preventDefault();
        if(!currentOrderItems.length) return;
        tempOrderData = {
            customerName: document.getElementById('customer-name').value,
            customerPhone: document.getElementById('customer-phone').value,
            staffId: document.getElementById('sales-staff').value,
            items: currentOrderItems.map(i => ({...i, subtotal: i.quantity * i.sellPrice})),
            transactionId: `DH${Date.now()}`
        };
        const method = document.getElementById('payment-method').value;
        const total = tempOrderData.items.reduce((s,i) => s+i.subtotal,0);
        if(method === 'Chuyển khoản') displayVietQR(total, tempOrderData.transactionId);
        else await finalizeOrder();
    };
    document.getElementById('confirm-payment-btn').onclick = async () => await finalizeOrder();

    // Import Logic
    document.getElementById('import-category-select').onchange = (e) => {
        const cat = e.target.value;
        const prods = allProducts.filter(p => p.category === cat);
        document.getElementById('import-product-select').innerHTML = `<option value="new">-- SP Mới --</option>` + prods.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    };
    document.getElementById('import-product-select').onchange = (e) => document.getElementById('new-product-fields').style.display = e.target.value === 'new' ? 'block' : 'none';
    document.getElementById('add-to-import-list-btn').onclick = () => {
        const pid = document.getElementById('import-product-select').value;
        const qty = parseInt(document.getElementById('import-quantity-input').value);
        if(pid === 'new') {
            currentImportItems.push({
                isNew: true, name: document.getElementById('new-product-name').value,
                importPrice: parseFloat(document.getElementById('new-import-price').value),
                sellPrice: parseFloat(document.getElementById('new-sell-price').value),
                category: document.getElementById('import-category-select').value, quantity: qty
            });
        } else {
            const p = allProducts.find(x => x.id === pid);
            currentImportItems.push({...p, isNew: false, quantity: qty});
        }
        renderImportList();
    };
    function renderImportList() {
        document.getElementById('import-list-table').innerHTML = currentImportItems.map((i, idx) => `<tr><td>${i.name}</td><td>${i.quantity}</td><td><button type="button" onclick="currentImportItems.splice(${idx},1);renderImportList()">X</button></td></tr>`).join('');
    }
    document.getElementById('import-form').onsubmit = async (e) => {
        e.preventDefault(); showLoader();
        const batch = db.batch(); let totalCost = 0;
        for(const item of currentImportItems) {
            totalCost += item.quantity * item.importPrice;
            if(item.isNew) {
                const ref = db.collection('products').doc();
                batch.set(ref, {name: item.name, importPrice: item.importPrice, sellPrice: item.sellPrice, category: item.category, inventory: item.quantity});
            } else {
                batch.update(db.collection('products').doc(item.id), { inventory: firebase.firestore.FieldValue.increment(item.quantity) });
            }
        }
        await batch.commit();
        await db.collection('transactions').add({ type: 'import', items: currentImportItems, totalCost, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
        currentImportItems = []; closeAllModals(); loadData(); hideLoader();
    };

    // Management (Staff, Category, Payment)
    document.getElementById('add-staff-form').onsubmit = async (e) => {
        e.preventDefault(); await db.collection('staff').add({name: document.getElementById('staff-name').value, commissionRate: document.getElementById('staff-commission').value});
        loadData(); document.getElementById('add-staff-form').reset();
    };
    document.getElementById('add-category-form').onsubmit = async (e) => {
        e.preventDefault(); await db.collection('categories').add({name: document.getElementById('category-name').value});
        loadData(); document.getElementById('add-category-form').reset();
    };
    async function loadPaymentInfo() {
        const res = await fetch('https://api.vietqr.io/v2/banks'); const data = await res.json();
        document.getElementById('bank-select').innerHTML = data.data.map(b => `<option value="${b.bin}">${b.shortName}</option>`).join('');
        if(paymentInfo) {
            document.getElementById('beneficiary-name').value = paymentInfo.beneficiaryName;
            document.getElementById('account-number').value = paymentInfo.accountNumber;
            document.getElementById('bank-select').value = paymentInfo.bankBin;
        }
    }
    document.getElementById('payment-info-form').onsubmit = async (e) => {
        e.preventDefault();
        await db.collection('settings').doc('paymentInfo').set({
            beneficiaryName: document.getElementById('beneficiary-name').value,
            accountNumber: document.getElementById('account-number').value,
            bankBin: document.getElementById('bank-select').value
        });
        showToast('Lưu cấu hình thanh toán thành công', 'success');
        loadData();
    };

    // History & Reports
    function renderHistory() {
        const exT = document.getElementById('export-history-table');
        const imT = document.getElementById('import-history-table');
        exT.innerHTML = allTransactions.filter(t => t.type==='export').map(t => `<tr><td>${t.transactionId}</td><td>${formatCurrency(t.totalRevenue)}</td><td>${t.customerName||''}</td></tr>`).join('');
        imT.innerHTML = allTransactions.filter(t => t.type==='import').map(t => `<tr><td>${t.items.length} loại</td><td>${formatCurrency(t.totalCost)}</td></tr>`).join('');
    }
    window.openTab = (e, name) => {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
        document.getElementById(name).classList.add('active');
        e.currentTarget.classList.add('active');
    };
    window.exportInventory = () => {
        const ws = XLSX.utils.json_to_sheet(allProducts.map(p => ({'Tên':p.name, 'Giá':p.sellPrice, 'Tồn':p.inventory})));
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Kho");
        XLSX.writeFile(wb, "KhoHang.xlsx");
    };

    // Chart & Report (Simplified)
    document.getElementById('revenue-report-form').onsubmit = (e) => {
        e.preventDefault();
        const start = new Date(document.getElementById('start-date').value);
        const end = new Date(document.getElementById('end-date').value);
        const filtered = allTransactions.filter(t => {
            if(!t.timestamp || t.type !== 'export') return false;
            const d = t.timestamp.toDate(); return d >= start && d <= end;
        });
        
        let totalRev = 0;
        const labels = [], data = [];
        filtered.forEach(t => { totalRev += t.totalRevenue; labels.push(t.timestamp.toDate().toLocaleDateString()); data.push(t.totalRevenue); });
        
        document.getElementById('report-summary-stats').innerHTML = `<p>Tổng thu: <strong>${formatCurrency(totalRev)}</strong></p>`;
        
        if(revenueChartInstance) revenueChartInstance.destroy();
        revenueChartInstance = new Chart(document.getElementById('revenue-chart'), {
            type: 'line', data: { labels, datasets: [{ label: 'Doanh thu', data, borderColor: 'blue', tension: 0.1 }] }
        });
    };

    // Edit Product
    window.editProduct = (id) => {
        const p = allProducts.find(x => x.id === id);
        document.getElementById('edit-product-id').value = id;
        document.getElementById('edit-product-name').value = p.name;
        document.getElementById('edit-import-price').value = p.importPrice;
        document.getElementById('edit-sell-price').value = p.sellPrice;
        document.getElementById('edit-category').value = p.category;
        openModal('edit-product-modal');
    };
    document.getElementById('edit-product-form').onsubmit = async (e) => {
        e.preventDefault();
        await db.collection('products').doc(document.getElementById('edit-product-id').value).update({
            name: document.getElementById('edit-product-name').value,
            importPrice: parseFloat(document.getElementById('edit-import-price').value),
            sellPrice: parseFloat(document.getElementById('edit-sell-price').value),
            category: document.getElementById('edit-category').value
        });
        closeAllModals(); loadData();
    };

</script>
</body>
</html>
