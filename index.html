<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Quản Lý Bán Hàng Toàn Diện</title>
    <!-- Thêm thư viện icon Remix Icon -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet"/>
    <style>
        :root { --primary-color: #0d6efd; --success-color: #198754; --danger-color: #dc3545; --warning-color: #ffc107; --info-color: #0dcaf0; --secondary-color: #6c757d; --light-gray: #f8f9fa; --border-color: #dee2e6;}
        
        /* --- Cài đặt chung & Font --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: var(--light-gray); color: #333; line-height: 1.6; }
        .container { max-width: 1400px; margin: 20px auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 6px 24px rgba(0,0,0,0.08); }
        .grid-container { display: grid; grid-template-columns: 1fr; gap: 30px; }
        @media (min-width: 992px) { .grid-container { grid-template-columns: repeat(2, 1fr); } }

        /* --- Icons --- */
        i { vertical-align: middle; }

        /* --- Authentication --- */
        #auth-container { max-width: 420px; margin: 50px auto; padding: 30px; border: 1px solid var(--border-color); border-radius: 12px; background: #fff; }
        .auth-form h2 { text-align: center; margin-bottom: 25px; color: var(--primary-color); }
        #register-form { display: none; }
        .form-toggle-link { color: var(--primary-color); text-decoration: none; cursor: pointer; display: block; margin-top: 15px; text-align: center; }
        .error-message { color: var(--danger-color); text-align: center; margin-top: 10px; min-height: 1em; }

        /* --- Main App --- */
        #app { display: none; }
        #user-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        h1, h2, h3 { color: #343a40; }
        h1 { display: flex; align-items: center; gap: 12px;}
        h2 { border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-top: 40px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-size: 1.5em;}
        input, select, button { padding: 12px 15px; margin: 8px 0; width: 100%; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; font-size: 16px; transition: all 0.2s ease-in-out; }
        input:focus, select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25); outline: none; }
        button { color: white; cursor: pointer; border: none; font-weight: 500; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: opacity 0.2s; }
        button:hover:not(:disabled) { opacity: 0.85; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid var(--border-color); padding: 14px; text-align: left; vertical-align: middle;}
        th { background-color: var(--light-gray); font-weight: 600; }
        tbody tr:hover { background-color: #f5f5f5; }
        .action-buttons button { width: auto; font-size: 14px; padding: 8px 14px; margin: 2px;}

        /* --- Dashboard & Main Buttons --- */
        .main-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .main-actions button { padding: 20px; font-size: 1.1em; font-weight: bold; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; }
        .stat-item { background-color: var(--light-gray); padding: 20px; border-radius: 8px; border-left: 5px solid; position: relative; overflow: hidden; }
        .stat-item p { margin: 0; font-size: 1.05em; color: #555; }
        .stat-item strong { font-size: 1.7em; color: #000; display: block; margin-top: 5px; }
        .stat-item .stat-icon { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); font-size: 3em; opacity: 0.15; }
        .stat-profit { border-color: var(--success-color); } .stat-profit strong { color: var(--success-color); }
        .stat-revenue { border-color: var(--primary-color); } .stat-revenue strong { color: var(--primary-color); }
        .stat-cost { border-color: var(--warning-color); } .stat-cost strong { color: var(--warning-color); }
        .stat-info { border-color: var(--info-color); } .stat-info strong { color: var(--info-color); }

        /* --- Modals --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .modal-content { background-color: #fefefe; padding: 30px; border: 1px solid #888; width: 100%; max-width: 550px; border-radius: 10px; animation: slide-down 0.4s ease-out; position: relative; }
        .modal-content.large { max-width: 1100px; }
        .modal-body { max-height: 78vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 25px; }
        .modal-header h2 { margin: 0; border: none; }
        .close { color: #aaa; font-size: 32px; font-weight: bold; cursor: pointer; line-height: 1; }
        @keyframes slide-down { from { transform: translateY(-40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* --- HIỆU ỨNG LOADING MỚI --- */
        #loader { display: flex; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.85); justify-content: center; align-items: center; flex-direction: column; gap: 15px; font-size: 1.2em; color: #333; opacity: 1; transition: opacity 0.3s ease-in-out; }
        #loader.hidden { opacity: 0; pointer-events: none; }
        .spinner { width: 50px; height: 50px; border-radius: 50%; display: inline-block; border-top: 5px solid var(--primary-color); border-right: 5px solid transparent; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- HỆ THỐNG THÔNG BÁO TOAST --- */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
        .toast { display: flex; align-items: center; gap: 15px; padding: 15px 20px; border-radius: 8px; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateX(120%); animation: slideIn 0.5s forwards, slideOut 0.5s 4.5s forwards; min-width: 320px; font-size: 16px; }
        .toast i { font-size: 24px; }
        .toast p { margin: 0; }
        .toast.info { background-color: var(--primary-color); }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }
        .toast.warning { background-color: var(--warning-color); }
        @keyframes slideIn { to { transform: translateX(0); } }
        @keyframes slideOut { from { transform: translateX(0); } to { transform: translateX(120%); opacity: 0; } }

        /* --- Specific Elements --- */
        #custom-alert-modal .modal-content { max-width: 450px; text-align: center; }
        #custom-alert-message { margin-bottom: 20px; font-size: 1.1em; }
        .danger-zone { border: 2px solid var(--danger-color); border-radius: 8px; padding: 20px; margin-top: 30px; background-color: #fffbeb; }
        .danger-zone h3 { color: var(--danger-color); display: flex; align-items: center; gap: 10px; margin-top: 0;}
        .cart-item-actions { display: flex; align-items: center; gap: 8px;}
        .cart-item-actions button { padding: 5px 10px; font-size: 14px; width: auto;}
        
        /* CSS CHO TÍNH NĂNG MỚI: HIỂN THỊ SỐ LẦN MUA */
        .customer-info-box {
            display: none; /* Ẩn mặc định */
            margin-top: 8px;
            padding: 10px 15px;
            background-color: #e7f5ff;
            border-left: 4px solid #0d6efd;
            border-radius: 5px;
            color: #005a9e;
            font-size: 0.95em;
            animation: fadeIn 0.5s;
        }
        .customer-info-box strong {
            font-size: 1.1em;
        }

        /* Tabs */
        .tabs { display: flex; border-bottom: 2px solid #ccc; margin-bottom: 20px; }
        .tab-link { padding: 12px 25px; cursor: pointer; background: #f1f1f1; border: 1px solid #ccc; border-bottom: none; margin-bottom: -2px; border-radius: 6px 6px 0 0; display: flex; align-items: center; gap: 8px;}
        .tab-link.active { background: #fff; border-bottom: 2px solid #fff; font-weight: bold; color: var(--primary-color);}
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Category product list */
        .category-product-list { display: none; }
        .category-product-list td { padding: 15px 15px 15px 40px; background-color: #fdfdff; }
        .category-row.active { background-color: #e9ecef; font-weight: bold; }
    </style>
</head>
<body>

<!-- TOAST CONTAINER -->
<div id="toast-container"></div>

<!-- LOADER OVERLAY -->
<div id="loader" class="hidden">
    <div class="spinner"></div>
    <p>Đang tải dữ liệu...</p>
</div>

<div class="container">
    <!-- AUTHENTICATION BLOCK -->
    <div id="auth-container">
        <form id="login-form" class="auth-form"><h2><i class="ri-login-box-line"></i> Đăng Nhập Hệ Thống</h2><input type="email" id="login-email" placeholder="Email" required><input type="password" id="login-password" placeholder="Mật khẩu" required><button type="submit" style="background-color: var(--primary-color);"><i class="ri-login-box-fill"></i> Đăng Nhập</button><p id="login-error" class="error-message"></p><span id="show-register" class="form-toggle-link">Chưa có tài khoản? Đăng ký</span></form>
        <form id="register-form" class="auth-form"><h2><i class="ri-user-add-line"></i> Đăng Ký Tài Khoản</h2><input type="email" id="register-email" placeholder="Email" required><input type="password" id="register-password" placeholder="Mật khẩu (ít nhất 6 ký tự)" required><button type="submit" style="background-color: var(--info-color);"><i class="ri-user-add-fill"></i> Đăng Ký</button><p id="register-error" class="error-message"></p><span id="show-login" class="form-toggle-link">Đã có tài khoản? Đăng nhập</span></form>
    </div>

    <!-- MAIN APP BLOCK -->
    <div id="app">
        <div id="user-info"><p>Xin chào, <strong id="user-email"></strong>!</p><button id="logout-button" style="background-color:var(--danger-color); width:auto;"><i class="ri-logout-box-r-line"></i> Đăng xuất</button></div>

        <h1><i class="ri-dashboard-fill"></i> Bảng Điều Khiển</h1>
        <div class="main-actions">
            <button onclick="openModal('sales-modal')" style="background-color: var(--primary-color);"><i class="ri-shopping-cart-2-line"></i> Tạo Đơn Hàng</button>
            <button onclick="openModal('inventory-modal')" style="background-color: var(--secondary-color);"><i class="ri-archive-line"></i> Quản Lý Kho</button>
            <button onclick="openModal('history-modal')" style="background-color: var(--info-color);"><i class="ri-history-line"></i> Lịch Sử Giao Dịch</button>
            <button onclick="openModal('revenue-report-modal')" style="background-color: var(--warning-color);"><i class="ri-line-chart-line"></i> Báo Cáo Doanh Thu</button>
        </div>

        <h2><i class="ri-numbers-line"></i> Thống Kê Nhanh</h2>
        <div class="stats-grid">
             <div class="stat-item stat-info"><p>Đơn hàng hôm nay</p><strong id="daily-orders">0</strong><i class="ri-calendar-check-line stat-icon"></i></div>
             <div class="stat-item stat-info"><p>Đơn hàng tuần này</p><strong id="weekly-orders">0</strong><i class="ri-calendar-todo-line stat-icon"></i></div>
             <div class="stat-item stat-info"><p>Đơn hàng tháng này</p><strong id="monthly-orders">0</strong><i class="ri-calendar-2-line stat-icon"></i></div>
             <div class="stat-item stat-cost"><p>Vốn nhập trong ngày</p><strong id="daily-cost">0 đ</strong><i class="ri-arrow-left-down-line stat-icon"></i></div>
            <div class="stat-item stat-info"><p>Sản phẩm trong kho</p><strong id="total-products">0</strong><i class="ri-box-3-line stat-icon"></i></div>
            <div class="stat-item stat-info"><p>Tổng số nhân viên</p><strong id="total-staff">0</strong><i class="ri-team-line stat-icon"></i></div>
        </div>

        <h2><i class="ri-money-dollar-circle-line"></i> Thống Kê Tài Chính</h2>
        <div class="stats-grid">
            <div class="stat-item stat-profit"><p>Tổng Lợi nhuận</p><strong id="total-profit">0 đ</strong><i class="ri-add-circle-line stat-icon"></i></div>
            <div class="stat-item stat-revenue"><p>Tổng Doanh thu</p><strong id="total-revenue">0 đ</strong><i class="ri-arrow-up-circle-line stat-icon"></i></div>
            <div class="stat-item stat-cost"><p>Tổng Vốn nhập</p><strong id="total-cost">0 đ</strong><i class="ri-arrow-down-circle-line stat-icon"></i></div>
            <div class="stat-item stat-warning"><p>Giá trị kho hàng</p><strong id="inventory-value">0 đ</strong><i class="ri-price-tag-3-line stat-icon"></i></div>
        </div>

        <div class="grid-container">
            <div class="management-section">
                <h2><i class="ri-settings-3-line"></i> Quản lý & Báo cáo</h2>
                <button onclick="openModal('staff-modal')" style="background-color: var(--secondary-color);"><i class="ri-user-settings-line"></i> Quản lý Nhân Viên</button>
                <button onclick="openModal('staff-report-modal')" style="background-color: var(--success-color); margin-top: 10px;"><i class="ri-file-chart-line"></i> Báo Cáo Doanh Số NV</button>
                <button onclick="openModal('category-modal')" style="background-color: var(--info-color); margin-top: 10px;"><i class="ri-folders-line"></i> Quản lý Danh mục & SP</button>
            </div>
            <div class="management-section">
                <h2><i class="ri-bank-card-line"></i> Thông tin thanh toán (VietQR)</h2>
                <form id="payment-info-form">
                    <input type="text" id="beneficiary-name" placeholder="Tên người thụ hưởng" required>
                    <input type="text" id="account-number" placeholder="Số tài khoản" required>
                    <select id="bank-select" required><option value="">Đang tải danh sách ngân hàng...</option></select>
                    <button type="submit" style="background-color: var(--primary-color);"><i class="ri-save-line"></i> Lưu Thông Tin</button>
                </form>
            </div>
        </div>

        <div class="danger-zone">
            <h3><i class="ri-alert-line"></i> Khu Vực Nguy Hiểm</h3>
            <p>Hành động này sẽ xóa vĩnh viễn tất cả dữ liệu sản phẩm, nhân viên và lịch sử giao dịch. Không thể hoàn tác.</p>
            <button id="reset-data-btn" style="background-color: var(--danger-color);"><i class="ri-delete-bin-2-line"></i> Reset Toàn Bộ Dữ Liệu</button>
        </div>
    </div>
</div>

<!-- MODALS -->

<!-- Inventory Modal -->
<div id="inventory-modal" class="modal"><div class="modal-content large"><div class="modal-header"><h2><i class="ri-archive-line"></i> Quản lý Kho Hàng</h2><span class="close">&times;</span></div><div class="modal-body">
    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 15px; margin-bottom: 15px;">
        <select id="inventory-category-filter"><option value="">-- Lọc theo danh mục --</option></select>
        <input type="text" id="inventory-search-input" placeholder="Tìm kiếm theo Tên hoặc Mã hàng...">
    </div>
    <button onclick="openModal('import-goods-modal')" style="background-color: var(--success-color);"><i class="ri-add-box-line"></i> Nhập Hàng Mới</button><div style="overflow-x: auto;"><table><thead><tr><th>Tên sản phẩm</th><th>Mã hàng</th><th>Giá nhập</th><th>Giá bán</th><th>Danh mục</th><th>Tồn kho</th><th>Đã bán</th><th>Hành động</th></tr></thead><tbody id="inventory-list-table"></tbody></table></div></div></div></div>

<!-- Edit Product Modal -->
<div id="edit-product-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2><i class="ri-edit-2-line"></i> Chỉnh Sửa Sản Phẩm</h2><span class="close">&times;</span></div><div class="modal-body"><form id="edit-product-form"><input type="hidden" id="edit-product-id"><input type="text" id="edit-product-name" placeholder="Tên sản phẩm" required><input type="text" id="edit-product-code" placeholder="Mã hàng"><input type="number" id="edit-import-price" placeholder="Giá nhập" required><input type="number" id="edit-sell-price" placeholder="Giá bán" required><select id="edit-category" required></select><button type="submit" style="background-color:var(--primary-color);"><i class="ri-save-line"></i> Lưu Thay Đổi</button></form></div></div></div>

<!-- Sales Modal -->
<div id="sales-modal" class="modal"><div class="modal-content large"><div class="modal-header"><h2><i class="ri-shopping-cart-2-line"></i> Tạo Đơn Hàng Mới</h2><span class="close">&times;</span></div><div class="modal-body"><form id="sales-form">
    <h3>1. Thông tin khách hàng</h3>
    <input type="tel" id="customer-phone" placeholder="SĐT Khách hàng (Bắt buộc)" required>
    <input type="text" id="customer-name" placeholder="Tên khách hàng" required>
    <!-- DIV HIỂN THỊ SỐ LẦN MUA HÀNG -->
    <div id="customer-purchase-info" class="customer-info-box"></div>
    
    <h3>2. Thêm sản phẩm vào đơn</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end;">
        <select id="sales-category-select"><option value="">-- Chọn danh mục --</option></select>
        <select id="sales-product-select"><option value="">-- Chọn danh mục trước --</option></select>
        <button type="button" id="add-to-cart-btn" style="width: auto; background-color: var(--primary-color);"><i class="ri-add-line"></i> Thêm</button>
    </div>
    <div id="sales-product-info" style="display:none; padding: 10px; background: #f0f8ff; border-radius: 5px; margin: 10px 0;">
        <p style="margin: 0;">Tồn kho: <strong id="sales-inventory-stock"></strong> | Giá bán: <strong id="sales-price"></strong></p>
    </div>

    <h3>3. Sản phẩm trong đơn hàng</h3>
    <div style="overflow-x: auto;"><table><thead><tr><th>Sản phẩm</th><th>SL</th><th>Đơn giá</th><th>Thành tiền</th><th>Xóa</th></tr></thead><tbody id="sales-cart-items"></tbody></table></div>
    
    <h3>4. Hoàn tất</h3>
    <select id="sales-staff" required><option value="">-- Chọn nhân viên bán hàng --</option></select>
    <select id="payment-method" required><option value="Tiền mặt">Tiền mặt</option><option value="Chuyển khoản">Chuyển khoản</option></select>
    <p style="font-size: 1.2em; text-align: right;"><strong>Tổng cộng: <span id="sales-total">0 đ</span></strong></p>
    <button type="submit" style="background-color: var(--primary-color);"><i class="ri-secure-payment-line"></i> Tiến Hành Thanh Toán</button>
</form></div></div></div>

<!-- Import Modal -->
<div id="import-goods-modal" class="modal"><div class="modal-content large"><div class="modal-header"><h2><i class="ri-inbox-archive-line"></i> Nhập Hàng Vào Kho</h2><span class="close">&times;</span></div><div class="modal-body"><form id="import-form"><h3>1. Thêm sản phẩm vào phiếu nhập</h3><div style="border: 1px solid #ccc; padding: 15px; border-radius: 5px;"><div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;"><select id="import-category-select" required><option value="">-- Chọn danh mục --</option></select><button type="button" id="add-new-category-import-btn" style="width: auto; padding: 0 15px; font-size: 1.5em;">+</button></div><select id="import-product-select" required><option value="">-- Chọn danh mục trước --</option></select><div id="new-product-fields" style="display:none; margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ccc;"><h4>Thông tin sản phẩm mới</h4><input type="text" id="new-product-name" placeholder="Tên sản phẩm mới"><input type="text" id="new-product-code" placeholder="Mã hàng (Tùy chọn)"><input type="number" id="new-import-price" placeholder="Giá nhập"><input type="number" id="new-sell-price" placeholder="Giá bán"></div><label>Số lượng nhập:</label><input type="number" id="import-quantity-input" min="1"><button type="button" id="add-to-import-list-btn" style="background-color: var(--primary-color);"><i class="ri-play-list-add-line"></i> Thêm vào phiếu</button></div><h3>2. Danh sách sản phẩm chuẩn bị nhập kho</h3><table><thead><tr><th>Sản phẩm</th><th>Số lượng</th><th>Hành động</th></tr></thead><tbody id="import-list-table"></tbody></table><button type="submit" id="confirm-import-btn" style="background-color:var(--success-color); margin-top: 20px;" disabled><i class="ri-check-double-line"></i> Xác nhận và Nhập Kho</button></form></div></div></div>

<!-- Staff Management Modal -->
<div id="staff-modal" class="modal"><div class="modal-content large"><div class="modal-header"><h2><i class="ri-user-settings-line"></i> Quản lý Nhân viên</h2><span class="close">&times;</span></div><div class="modal-body"><h3>Thêm / Chỉnh sửa nhân viên</h3><form id="add-staff-form" style="display:flex; flex-wrap:wrap; gap:10px;"><input type="hidden" id="staff-id"><input type="text" id="staff-name" placeholder="Tên nhân viên" required style="flex:1 1 200px;"><input type="number" id="staff-commission" placeholder="Hoa hồng (%)" required min="0" step="0.1" style="flex:1 1 120px;"><div style="flex:1 1 100%; display:flex; gap:10px;"><button type="submit" style="background-color: var(--primary-color); flex-grow:1;"><i class="ri-save-line"></i> Lưu</button><button type="button" id="clear-staff-form-btn" style="background-color: var(--secondary-color); flex-grow:1;"><i class="ri-refresh-line"></i> Làm mới</button></div></form><h3>Danh sách nhân viên</h3><div style="overflow-x: auto;"><table><thead><tr><th>Tên Nhân Viên</th><th>Hoa hồng (%)</th><th>Hành Động</th></tr></thead><tbody id="staff-list-table"></tbody></table></div></div></div></div>

<!-- Category Management Modal -->
<div id="category-modal" class="modal"><div class="modal-content large"><div class="modal-header"><h2><i class="ri-folders-line"></i> Quản lý Danh mục & Sản phẩm</h2><span class="close">&times;</span></div><div class="modal-body"><h3>Thêm danh mục mới</h3><form id="add-category-form" style="display: flex; gap: 10px;"><input type="text" id="category-name" placeholder="Tên danh mục" required><button type="submit" style="background-color: var(--primary-color); width: 30%;"><i class="ri-add-line"></i> Thêm</button></form><h3>Danh sách danh mục (click để xem sản phẩm)</h3><div style="overflow-x: auto;"><table><thead><tr><th>Tên Danh Mục</th><th>Số SP</th><th>Hành Động</th></tr></thead><tbody id="category-list-table"></tbody></table></div></div></div></div>

<!-- Transaction History Modal -->
<div id="history-modal" class="modal"><div class="modal-content large"><div class="modal-header"><h2><i class="ri-history-line"></i> Lịch Sử Giao Dịch</h2><span class="close">&times;</span></div><div class="modal-body"><input type="text" id="history-search-input" placeholder="Tìm theo Mã ĐH, SĐT KH, Tên SP, Tên NV..."><div class="tabs"><div class="tab-link active" onclick="openTab(event, 'export-history')"><i class="ri-upload-line"></i> Lịch Sử Xuất Hàng</div><div class="tab-link" onclick="openTab(event, 'import-history')"><i class="ri-download-line"></i> Lịch Sử Nhập Hàng</div></div><div id="export-history" class="tab-content active"><div style="overflow-x: auto;"><table><thead><tr><th>Thời gian</th><th>Mã ĐH</th><th>Chi tiết</th><th>Nhân viên</th><th>Khách hàng</th><th>Tổng tiền</th></tr></thead><tbody id="export-history-table"></tbody></table></div></div><div id="import-history" class="tab-content"><div style="overflow-x: auto;"><table><thead><tr><th>Thời gian</th><th>Chi tiết</th><th>Tổng vốn</th></tr></thead><tbody id="import-history-table"></tbody></table></div></div></div></div></div>

<!-- Staff Report Modal -->
<div id="staff-report-modal" class="modal"><div class="modal-content large"><div class="modal-header"><h2><i class="ri-file-chart-line"></i> Báo Cáo Doanh Số Nhân Viên</h2><span class="close">&times;</span></div><div class="modal-body"><button onclick="renderStaffReport()" style="background-color: var(--primary-color); margin-bottom: 15px; width: auto;"><i class="ri-refresh-line"></i> Rà soát / Làm mới</button><h3>Bảng tổng hợp</h3><div style="overflow-x: auto;"><table><thead><tr><th>Nhân viên</th><th>Tổng số đơn</th><th>Số đơn (tuần)</th><th>Số đơn (tháng)</th><th>Tổng doanh thu</th><th>Tổng lợi nhuận</th><th>Tỷ lệ HH</th><th>Tiền Hoa hồng</th></tr></thead><tbody id="staff-report-table"></tbody></table></div></div></div></div>

<!-- Revenue Report Modal -->
<div id="revenue-report-modal" class="modal"><div class="modal-content large"><div class="modal-header"><h2><i class="ri-line-chart-line"></i> Báo Cáo Doanh Thu</h2><span class="close">&times;</span></div><div class="modal-body"><form id="revenue-report-form" style="display:flex; gap: 15px; align-items:center; margin-bottom:20px; flex-wrap:wrap;"><div><label for="start-date">Từ ngày:</label><input type="date" id="start-date" required></div><div><label for="end-date">Đến ngày:</label><input type="date" id="end-date" required></div><button type="submit" style="width:auto; padding: 12px 20px;"><i class="ri-search-line"></i> Xem Báo Cáo</button></form><div id="report-results"></div></div></div></div>

<!-- QR Code Confirmation Modal -->
<div id="qr-confirm-modal" class="modal"><div class="modal-content" style="text-align: center;"><div class="modal-header"><h2><i class="ri-qr-scan-2-line"></i> Xác Nhận Thanh Toán (VietQR)</h2><span class="close">&times;</span></div><div class="modal-body"><img id="qr-code-image" src="" alt="QR Code" style="max-width: 100%; height: auto; border: 1px solid var(--border-color); border-radius: 8px;"><div id="qr-info" style="margin-top: 15px; text-align: left; background: #f3f3f3; padding: 10px; border-radius: 5px;"><p><strong>Nội dung:</strong> <span id="qr-content"></span></p></div><button id="confirm-payment-btn" style="background-color: var(--success-color); margin-top:20px;"><i class="ri-check-double-line"></i> Xác nhận Đã nhận tiền & Hoàn tất</button></div></div></div>

<!-- Custom Alert Modal (Dùng cho các cảnh báo quan trọng) -->
<div id="custom-alert-modal" class="modal" style="z-index: 9999;"><div class="modal-content"><div class="modal-header"><h2><i class="ri-notification-3-line"></i> Thông Báo</h2><span class="close" style="display: none;">&times;</span></div><div class="modal-body"><p id="custom-alert-message"></p><button id="custom-alert-ok" style="background-color: var(--primary-color); width: 100px; margin: 0 auto; display: block;">OK</button></div></div></div>


<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<script>
    // --- 1. INITIALIZATION & CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyCHjgJkqVmgpZ6s5HRobpqB6XT--Sa2_zY",
        authDomain: "tgapp-30a28.firebaseapp.com",
        projectId: "tgapp-30a28",
        storageBucket: "tgapp-30a28.firebasestorage.app",
        messagingSenderId: "329047273664",
        appId: "1:329047273664:web:c9e1bfe367afb54953fd25",
        measurementId: "G-68P4PT49B0"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- 2. GLOBAL STATE & DOM ELEMENTS ---
    let allProductsCache = [], allTransactionsCache = [], allCategoriesCache = [], allStaffCache = [], allCustomersCache = [], paymentInfoCache = null;
    let currentOrderItems = [];
    let currentImportItems = [];
    let tempOrderData = null; // For QR confirmation
    const loader = document.getElementById('loader');

    // --- 3. HELPER & UTILITY FUNCTIONS ---
    const showLoader = (message = "Đang xử lý...") => {
        loader.querySelector('p').textContent = message;
        loader.style.display = 'flex';
        setTimeout(() => loader.classList.remove('hidden'), 10);
    };
    const hideLoader = () => {
        loader.classList.add('hidden');
        setTimeout(() => { loader.style.display = 'none'; }, 300);
    };
    const formatCurrency = (num) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(num || 0);
    
    // ** HỆ THỐNG THÔNG BÁO TOAST MỚI **
    function showToast(message, type = 'info') { // types: info, success, error, warning
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        let iconClass = 'ri-information-line';
        if (type === 'success') iconClass = 'ri-checkbox-circle-line';
        if (type === 'error') iconClass = 'ri-error-warning-line';
        if (type === 'warning') iconClass = 'ri-alert-line';

        toast.innerHTML = `<i class="${iconClass}"></i> <p>${message}</p>`;
        container.appendChild(toast);

        // Tự động xóa thông báo sau 5 giây
        setTimeout(() => { toast.remove(); }, 5000);
    }
    
    // ** ALERT MODAL DÀNH CHO CÁC THÔNG BÁO QUAN TRỌNG CẦN CHẶN MÀN HÌNH **
    const showModalAlert = (message, callback) => {
        closeAllModals(); 
        document.getElementById('custom-alert-message').textContent = message;
        const modal = document.getElementById('custom-alert-modal');
        modal.style.display = 'flex';
        activeModal = 'custom-alert-modal';
        document.getElementById('custom-alert-ok').onclick = () => {
             closeModal('custom-alert-modal');
             if (callback) callback();
        };
    };

    let activeModal = null;
    function openModal(modalId) {
        if (activeModal) closeModal(activeModal);
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'flex';
            activeModal = modalId;
            // Specific actions on modal open
            if(modalId === 'inventory-modal') { populateCategoryDropdown('inventory-category-filter', true); renderInventoryTable(); }
            if(modalId === 'sales-modal') resetSalesForm();
            if(modalId === 'staff-modal') renderStaffTable();
            if(modalId === 'history-modal') renderHistoryTables();
            if(modalId === 'staff-report-modal') renderStaffReport();
            if(modalId === 'import-goods-modal') resetImportForm();
            if(modalId === 'category-modal') renderCategoryTable();
            if(modalId === 'revenue-report-modal') {
                document.getElementById('end-date').valueAsDate = new Date();
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                document.getElementById('start-date').valueAsDate = sevenDaysAgo;
                document.getElementById('report-results').innerHTML = '';
            }
        }
    }
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.style.display = 'none';
        if (activeModal === modalId) activeModal = null;
    }
    function closeAllModals() {
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        activeModal = null;
    }

    function openTab(evt, tabName) {
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        document.querySelectorAll('.tab-link').forEach(tl => tl.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        evt.currentTarget.classList.add('active');
    }

    // --- 4. AUTHENTICATION ---
    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            document.getElementById('user-email').textContent = user.email;
            loadInitialData();
        } else {
            document.getElementById('auth-container').style.display = 'block';
            document.getElementById('app').style.display = 'none';
            hideLoader();
        }
    });
    
    document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); showLoader("Đang đăng nhập..."); auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value).catch(err => { document.getElementById('login-error').textContent = "Email hoặc mật khẩu không đúng."; hideLoader(); }); });
    document.getElementById('register-form').addEventListener('submit', (e) => { e.preventDefault(); showLoader("Đang tạo tài khoản..."); auth.createUserWithEmailAndPassword(document.getElementById('register-email').value, document.getElementById('register-password').value).catch(err => { document.getElementById('register-error').textContent = err.message; hideLoader(); }); });
    document.getElementById('show-register').addEventListener('click', () => { document.getElementById('login-form').style.display = 'none'; document.getElementById('register-form').style.display = 'block'; });
    document.getElementById('show-login').addEventListener('click', () => { document.getElementById('register-form').style.display = 'none'; document.getElementById('login-form').style.display = 'block'; });
    document.getElementById('logout-button').addEventListener('click', () => auth.signOut());

    // --- 5. CORE DATA LOADING & RENDERING ---
    async function loadInitialData() {
        showLoader("Đang tải dữ liệu...");
        try {
            const [p, t, c, s, cust, paymentInfo] = await Promise.all([
                db.collection('products').orderBy('name').get(),
                db.collection('transactions').orderBy('timestamp', 'desc').get(),
                db.collection('categories').orderBy('name').get(),
                db.collection('staff').orderBy('name').get(),
                db.collection('customers').get(),
                db.collection('settings').doc('paymentInfo').get()
            ]);
            allProductsCache = p.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            allTransactionsCache = t.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            allCategoriesCache = c.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            allStaffCache = s.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            allCustomersCache = cust.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            paymentInfoCache = paymentInfo.exists ? paymentInfo.data() : null;

            updateDashboardStats();
            loadPaymentInfo(paymentInfoCache);
            populateCategoryDropdown('sales-category-select', true);
        } catch (error) {
            console.error("Lỗi khi tải dữ liệu:", error);
            showToast("Không thể tải dữ liệu từ server.", 'error');
        } finally {
            hideLoader();
        }
    }
    
    function updateDashboardStats() {
        const now = new Date();
        const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const dayOfWeek = now.getDay();
        const startOfWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        let totalRevenue = 0, totalCost = 0, totalProfit = 0, dailyOrders = 0, weeklyOrders = 0, monthlyOrders = 0, dailyCost = 0;
        allTransactionsCache.forEach(t => {
            const tDate = t.timestamp ? t.timestamp.toDate() : null;
            if (t.type === 'export') {
                totalRevenue += t.totalRevenue || 0;
                totalProfit += t.totalProfit || 0;
                if (tDate && tDate >= startOfDay) dailyOrders++;
                if (tDate && tDate >= startOfWeek) weeklyOrders++;
                if (tDate && tDate >= startOfMonth) monthlyOrders++;
            } else { // import
                const cost = t.totalCost || 0;
                totalCost += cost;
                if (tDate && tDate >= startOfDay) { dailyCost += cost; }
            }
        });
        const inventoryValue = allProductsCache.reduce((sum, p) => sum + ((p.inventory || 0) * (p.importPrice || 0)), 0);
        document.getElementById('daily-orders').textContent = dailyOrders;
        document.getElementById('weekly-orders').textContent = weeklyOrders;
        document.getElementById('monthly-orders').textContent = monthlyOrders;
        document.getElementById('daily-cost').textContent = formatCurrency(dailyCost);
        document.getElementById('total-products').textContent = allProductsCache.length;
        document.getElementById('total-staff').textContent = allStaffCache.length;
        document.getElementById('total-profit').textContent = formatCurrency(totalProfit);
        document.getElementById('total-revenue').textContent = formatCurrency(totalRevenue);
        document.getElementById('total-cost').textContent = formatCurrency(totalCost);
        document.getElementById('inventory-value').textContent = formatCurrency(inventoryValue);
    }
    
    // --- 6. FEATURE-SPECIFIC LOGIC ---
    // ** Category Management **
    document.getElementById('add-category-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const nameInput = document.getElementById('category-name');
        const name = nameInput.value.trim();
        if (!name) return;
        showLoader();
        try {
            await db.collection('categories').add({ name });
            closeModal('category-modal');
            showToast("Thêm danh mục thành công!", 'success');
            nameInput.value = '';
            await loadInitialData();
            openModal('category-modal');
        } catch (error) {
            hideLoader();
            showToast("Lỗi: " + error.message, 'error');
        }
    });

    function renderCategoryTable() {
        const tableBody = document.getElementById('category-list-table');
        tableBody.innerHTML = allCategoriesCache.map(cat => {
            const productCount = allProductsCache.filter(p => p.category === cat.name).length;
            return `
            <tr class="category-row" id="cat-row-${cat.id}">
                <td style="cursor: pointer;" onclick="toggleCategoryProducts('${cat.id}', '${cat.name}')"><i class="ri-folder-line"></i> ${cat.name}</td>
                <td>${productCount}</td>
                <td class="action-buttons">
                    <button onclick="editCategory('${cat.id}', '${cat.name}')" style="background-color: var(--warning-color);"><i class="ri-pencil-line"></i></button>
                    <button onclick="deleteCategory('${cat.id}', '${cat.name}')" style="background-color: var(--danger-color);"><i class="ri-delete-bin-line"></i></button>
                </td>
            </tr>
            <tr class="category-product-list" id="cat-products-${cat.id}"><td colspan="3">Đang tải sản phẩm...</td></tr>
        `}).join('');
    }
    window.toggleCategoryProducts = (catId, catName) => {
        const productRow = document.getElementById(`cat-products-${catId}`);
        const catRow = document.getElementById(`cat-row-${catId}`);
        const isVisible = productRow.style.display === 'table-row';

        document.querySelectorAll('.category-product-list').forEach(row => row.style.display = 'none');
        document.querySelectorAll('.category-row').forEach(row => row.classList.remove('active'));

        if (!isVisible) {
            productRow.style.display = 'table-row';
            catRow.classList.add('active');
            const products = allProductsCache.filter(p => p.category === catName);
            const content = products.length > 0 ? 
                `<ul>${products.map(p => `<li>${p.name} (Tồn: ${p.inventory || 0})</li>`).join('')}</ul>` : 
                `<p style="padding: 10px;">Không có sản phẩm nào trong danh mục này.</p>`;
            productRow.querySelector('td').innerHTML = content;
        }
    };
    window.editCategory = async (id, oldName) => {
        const newName = prompt("Nhập tên danh mục mới:", oldName);
        if (newName && newName.trim() && newName.trim() !== oldName) {
            showLoader("Đang cập nhật danh mục...");
            try {
                const productsToUpdate = allProductsCache.filter(p => p.category === oldName);
                const batch = db.batch();
                const catRef = db.collection('categories').doc(id);
                batch.update(catRef, { name: newName.trim() });
                productsToUpdate.forEach(p => {
                    const productRef = db.collection('products').doc(p.id);
                    batch.update(productRef, { category: newName.trim() });
                });
                await batch.commit();
                closeModal('category-modal');
                showToast("Cập nhật danh mục thành công!", 'success');
                await loadInitialData();
                openModal('category-modal');
            } catch (error) {
                hideLoader();
                showToast("Lỗi khi cập nhật: " + error.message, 'error');
            }
        }
    };
    window.deleteCategory = async (id, name) => {
        const used = allProductsCache.some(p => p.category === name);
        if(used) {
            showToast(`Không thể xóa, vẫn còn sản phẩm trong danh mục "${name}".`, 'error');
            return;
        }
        if (confirm(`Bạn có chắc muốn xóa danh mục "${name}" không?`)) {
            showLoader();
            try {
                await db.collection('categories').doc(id).delete();
                showToast("Xóa danh mục thành công!", 'success');
                await loadInitialData();
                renderCategoryTable();
            } catch (error) {
                showToast("Lỗi: " + error.message, 'error');
            } finally {
                hideLoader();
            }
        }
    };
    
    // ** Payment Info (VietQR) **
    async function fetchBankList() {
        try {
            const response = await fetch('https://api.vietqr.io/v2/banks');
            const data = await response.json();
            if(data.code === '00') {
                const bankSelect = document.getElementById('bank-select');
                bankSelect.innerHTML = '<option value="">-- Chọn ngân hàng --</option>' + data.data.map(bank => 
                    `<option value="${bank.bin}">${bank.shortName} - ${bank.name}</option>`
                ).join('');
            }
        } catch (error) { console.error("Lỗi khi tải danh sách ngân hàng:", error); document.getElementById('bank-select').innerHTML = '<option value="">Không tải được danh sách</option>'; }
    }
    function loadPaymentInfo(data) {
        if (data) {
            document.getElementById('beneficiary-name').value = data.beneficiaryName || '';
            document.getElementById('account-number').value = data.accountNumber || '';
            const bankSelect = document.getElementById('bank-select');
            const checkOptions = () => { if (bankSelect.options.length > 1) { bankSelect.value = data.bankBin || ''; } };
            if (bankSelect.options.length > 1) { checkOptions(); } 
            else { const observer = new MutationObserver(() => { checkOptions(); observer.disconnect(); }); observer.observe(bankSelect, { childList: true }); }
        }
    }
    document.getElementById('payment-info-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        showLoader();
        const bankSelect = document.getElementById('bank-select');
        const selectedOption = bankSelect.options[bankSelect.selectedIndex];
        const data = { beneficiaryName: document.getElementById('beneficiary-name').value, accountNumber: document.getElementById('account-number').value, bankBin: document.getElementById('bank-select').value, bankInfo: selectedOption.text };
        try {
            await db.collection('settings').doc('paymentInfo').set(data);
            paymentInfoCache = data;
            showToast("Lưu thông tin thanh toán thành công!", 'success');
        } catch (error) { showToast("Lỗi: " + error.message, 'error'); } 
        finally { hideLoader(); }
    });

    // ** Staff Management **
    document.getElementById('add-staff-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('staff-id').value;
        const name = document.getElementById('staff-name').value.trim();
        const commissionRate = parseFloat(document.getElementById('staff-commission').value);
        if (!name || isNaN(commissionRate)) { showToast("Vui lòng nhập đầy đủ thông tin.", "error"); return; }
        showLoader();
        try {
            const staffData = { name, commissionRate };
            if (id) { await db.collection('staff').doc(id).update(staffData); } 
            else { await db.collection('staff').add(staffData); }
            showToast("Lưu thông tin nhân viên thành công!", 'success');
            document.getElementById('add-staff-form').reset(); 
            await loadInitialData();
            renderStaffTable();
        } catch (error) { 
            showToast("Lỗi: " + error.message, 'error'); 
        } finally {
            hideLoader();
        }
    });
    document.getElementById('clear-staff-form-btn').addEventListener('click', () => { document.getElementById('add-staff-form').reset(); document.getElementById('staff-id').value = ''; });
    function renderStaffTable() {
        const tableBody = document.getElementById('staff-list-table');
        tableBody.innerHTML = allStaffCache.map(staff => `
            <tr>
                <td>${staff.name}</td>
                <td>${staff.commissionRate || 0}%</td>
                <td class="action-buttons">
                    <button onclick="editStaff('${staff.id}')" style="background-color: var(--warning-color);"><i class="ri-pencil-line"></i> Sửa</button>
                    <button onclick="deleteStaff('${staff.id}', '${staff.name}')" style="background-color: var(--danger-color);"><i class="ri-delete-bin-line"></i> Xóa</button>
                </td>
            </tr>`).join('');
    }
    window.editStaff = (id) => {
        const staff = allStaffCache.find(s => s.id === id);
        if (staff) { document.getElementById('staff-id').value = staff.id; document.getElementById('staff-name').value = staff.name; document.getElementById('staff-commission').value = staff.commissionRate || 0; }
    };
    window.deleteStaff = async (id, name) => {
        if (confirm(`Bạn có chắc muốn xóa nhân viên "${name}" không?`)) {
            showLoader();
            try { 
                await db.collection('staff').doc(id).delete(); 
                showToast("Xóa nhân viên thành công!", 'success');
                await loadInitialData();
                renderStaffTable();
            } 
            catch (error) { showToast("Lỗi: " + error.message, 'error'); }
            finally { hideLoader(); }
        }
    };

    // ** Inventory Management & Edit Product **
    document.getElementById('inventory-search-input').addEventListener('input', () => renderInventoryTable());
    document.getElementById('inventory-category-filter').addEventListener('change', () => renderInventoryTable());

    function renderInventoryTable() {
        const searchTerm = document.getElementById('inventory-search-input').value.toLowerCase();
        const categoryFilter = document.getElementById('inventory-category-filter').value;
        let filtered = allProductsCache;
        if (categoryFilter) { filtered = filtered.filter(p => p.category === categoryFilter); }
        if (searchTerm) { filtered = filtered.filter(p => p.name.toLowerCase().includes(searchTerm) || (p.code && p.code.toLowerCase().includes(searchTerm))); }
        const tableBody = document.getElementById('inventory-list-table');
        tableBody.innerHTML = filtered.map(p => {
            let soldCount = 0;
            allTransactionsCache.forEach(t => { if (t.type === 'export' && t.items && Array.isArray(t.items)) { t.items.forEach(item => { if(item.productId === p.id) soldCount += item.quantity; }); } });
            return `
            <tr>
                <td>${p.name}</td><td>${p.code || ''}</td><td>${formatCurrency(p.importPrice)}</td><td>${formatCurrency(p.sellPrice)}</td><td>${p.category}</td>
                <td><strong>${p.inventory}</strong></td><td>${soldCount}</td>
                <td class="action-buttons">
                     <button onclick="openEditProductModal('${p.id}')" style="background-color: var(--warning-color);"><i class="ri-pencil-line"></i> Sửa</button>
                     <button onclick="deleteProduct('${p.id}', '${p.name}')" style="background-color: var(--danger-color);"><i class="ri-delete-bin-line"></i> Xóa</button>
                </td>
            </tr>`}).join('');
    }
    window.openEditProductModal = (productId) => {
        const product = allProductsCache.find(p => p.id === productId);
        if (product) {
            document.getElementById('edit-product-id').value = product.id;
            document.getElementById('edit-product-name').value = product.name;
            document.getElementById('edit-product-code').value = product.code || '';
            document.getElementById('edit-import-price').value = product.importPrice;
            document.getElementById('edit-sell-price').value = product.sellPrice;
            populateCategoryDropdown('edit-category', false, product.category);
            openModal('edit-product-modal');
        }
    };
    document.getElementById('edit-product-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('edit-product-id').value;
        const name = document.getElementById('edit-product-name').value.trim();
        const importPrice = parseFloat(document.getElementById('edit-import-price').value);
        const sellPrice = parseFloat(document.getElementById('edit-sell-price').value);
        const category = document.getElementById('edit-category').value;
        if (!name || !category || isNaN(importPrice) || isNaN(sellPrice)) { showToast("Vui lòng điền đầy đủ và chính xác.", "error"); return; }
        const data = { name, code: document.getElementById('edit-product-code').value, importPrice, sellPrice, category };
        showLoader();
        try { 
            await db.collection('products').doc(id).update(data);
            closeModal('edit-product-modal');
            showToast("Cập nhật sản phẩm thành công!", 'success');
            await loadInitialData();
            openModal('inventory-modal');
        } 
        catch(error) { hideLoader(); showToast("Lỗi: " + error.message, 'error'); }
    });
    window.deleteProduct = async (id, name) => {
        if (confirm(`Bạn có chắc muốn xóa vĩnh viễn sản phẩm "${name}" không?`)) {
            showLoader();
            try { 
                await db.collection('products').doc(id).delete();
                showToast("Xóa sản phẩm thành công!", 'success');
                await loadInitialData();
                renderInventoryTable();
            } 
            catch (error) { showToast("Lỗi: " + error.message, 'error'); }
            finally { hideLoader(); }
        }
    };
    
    // ** Import Goods (New Flow) **
    function resetImportForm() {
        document.getElementById('import-form').reset();
        populateCategoryDropdown('import-category-select', false);
        document.getElementById('import-product-select').innerHTML = '<option value="">-- Chọn danh mục trước --</option>';
        document.getElementById('new-product-fields').style.display = 'none';
        currentImportItems = [];
        renderImportList();
    }
    document.getElementById('add-new-category-import-btn').addEventListener('click', async () => {
        const categoryName = prompt("Nhập tên danh mục mới:");
        if (categoryName && categoryName.trim()) {
            showLoader();
            try {
                const newCat = { name: categoryName.trim() };
                await db.collection('categories').add(newCat);
                await loadInitialData();
                populateCategoryDropdown('import-category-select', false, newCat.name);
                document.getElementById('import-category-select').dispatchEvent(new Event('change'));
                showToast("Thêm danh mục mới thành công", "success");
            } catch(error) { showToast("Lỗi: " + error.message, "error"); } 
            finally { hideLoader(); }
        }
    });
    document.getElementById('import-category-select').addEventListener('change', (e) => {
        const category = e.target.value;
        const productsInCategory = allProductsCache.filter(p => p.category === category);
        const select = document.getElementById('import-product-select');
        select.innerHTML = `<option value="" disabled selected>-- Chọn sản phẩm hoặc thêm mới --</option>
            ${productsInCategory.map(p => `<option value="${p.id}">${p.name} (${p.code || 'N/A'})</option>`).join('')}
            <option value="new" style="font-weight: bold; color: var(--primary-color);">-- Thêm sản phẩm mới --</option>`;
    });
    document.getElementById('import-product-select').addEventListener('change', (e) => { document.getElementById('new-product-fields').style.display = e.target.value === 'new' ? 'block' : 'none'; });
    document.getElementById('add-to-import-list-btn').addEventListener('click', () => {
        const category = document.getElementById('import-category-select').value;
        const productId = document.getElementById('import-product-select').value;
        const quantity = parseInt(document.getElementById('import-quantity-input').value);
        if (!category || !productId) { showToast("Vui lòng chọn danh mục và sản phẩm.", "error"); return; }
        if (isNaN(quantity) || quantity <= 0) { showToast("Vui lòng nhập số lượng hợp lệ.", "error"); return; }
        if (productId === 'new') {
            const newItem = { isNew: true, id: `new_${Date.now()}`, name: document.getElementById('new-product-name').value.trim(), code: document.getElementById('new-product-code').value.trim(), importPrice: parseFloat(document.getElementById('new-import-price').value), sellPrice: parseFloat(document.getElementById('new-sell-price').value), category: category, quantity: quantity };
            if (!newItem.name || isNaN(newItem.importPrice) || isNaN(newItem.sellPrice)) { showToast("Điền đủ thông tin cho sản phẩm mới.", "error"); return; }
            currentImportItems.push(newItem);
        } else {
            const product = allProductsCache.find(p => p.id === productId);
            if (product) {
                const existingItem = currentImportItems.find(item => item.id === productId);
                if(existingItem) { existingItem.quantity += quantity; } 
                else { currentImportItems.push({ ...product, quantity, isNew: false }); }
            }
        }
        renderImportList();
        document.getElementById('import-quantity-input').value = '';
        document.getElementById('import-product-select').selectedIndex = 0;
        document.getElementById('new-product-fields').style.display = 'none';
        document.getElementById('new-product-fields').querySelectorAll('input').forEach(el => el.value = '');
    });
    function renderImportList() {
        const tableBody = document.getElementById('import-list-table');
        const confirmBtn = document.getElementById('confirm-import-btn');
        tableBody.innerHTML = currentImportItems.map((item, index) => `<tr><td>${item.name} ${item.isNew ? '(Mới)' : ''}</td><td>${item.quantity}</td><td><button type="button" onclick="removeFromImportList(${index})" style="background-color:var(--danger-color); width:auto; padding:5px 10px;"><i class="ri-close-line"></i></button></td></tr>`).join('');
        confirmBtn.disabled = currentImportItems.length === 0;
    }
    window.removeFromImportList = (index) => { currentImportItems.splice(index, 1); renderImportList(); };
    document.getElementById('import-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        let totalCost = currentImportItems.reduce((sum, item) => sum + item.quantity * (item.importPrice || 0), 0);
        if (!confirm(`Bạn có chắc muốn nhập ${currentImportItems.length} loại sản phẩm với tổng vốn là ${formatCurrency(totalCost)} không?`)) return;
        showLoader("Đang nhập hàng...");
        try {
            const batch = db.batch(); const transactionItems = [];
            for (const item of currentImportItems) {
                if (item.isNew) {
                    const newProductRef = db.collection('products').doc();
                    batch.set(newProductRef, { name: item.name, code: item.code, importPrice: item.importPrice, sellPrice: item.sellPrice, category: item.category, inventory: item.quantity });
                    transactionItems.push({productId: newProductRef.id, name: item.name, quantity: item.quantity, importPrice: item.importPrice});
                } else {
                    const productRef = db.collection('products').doc(item.id);
                    batch.update(productRef, { inventory: firebase.firestore.FieldValue.increment(item.quantity) });
                    transactionItems.push({productId: item.id, name: item.name, quantity: item.quantity, importPrice: item.importPrice});
                }
            }
            await batch.commit();
            await createTransaction('import', transactionItems, 0, totalCost, 0, auth.currentUser.email);
            closeModal('import-goods-modal');
            showToast('Nhập hàng thành công!', 'success');
            await loadInitialData();
            openModal('inventory-modal');
        } catch(error) { hideLoader(); showToast("Lỗi khi nhập hàng: " + error.message, 'error'); }
    });

    // ** Sales (with Category Filter & QR Confirmation) **
    function resetSalesForm() {
        document.getElementById('sales-form').reset();
        document.getElementById('customer-name').readOnly = false;
        // Cập nhật để ẩn ô thông tin khách hàng
        document.getElementById('customer-purchase-info').style.display = 'none';
        populateStaffDropdown('sales-staff');
        populateCategoryDropdown('sales-category-select', true);
        document.getElementById('sales-product-select').innerHTML = '<option value="">-- Chọn danh mục trước --</option>';
        document.getElementById('sales-product-info').style.display = 'none';
        currentOrderItems = [];
        renderSalesCart();
    }
    
    // CẬP NHẬT HOÀN CHỈNH TÍNH NĂNG KIỂM TRA SĐT KHÁCH HÀNG
    document.getElementById('customer-phone').addEventListener('blur', (e) => {
        const phone = e.target.value.trim();
        const nameInput = document.getElementById('customer-name');
        const purchaseInfoDiv = document.getElementById('customer-purchase-info');

        // Luôn ẩn ô thông tin khi bắt đầu kiểm tra
        purchaseInfoDiv.style.display = 'none';
        purchaseInfoDiv.innerHTML = '';

        if (phone) {
            const existingCustomer = allCustomersCache.find(c => c.phone === phone);
            if (existingCustomer) {
                nameInput.value = existingCustomer.name;
                nameInput.readOnly = true;

                // --- LOGIC MỚI ĐỂ ĐẾM SỐ LẦN MUA ---
                const purchaseCount = allTransactionsCache.filter(
                    t => t.type === 'export' && t.customerPhone === phone
                ).length;
                
                // Hiển thị thông tin
                purchaseInfoDiv.innerHTML = `<i class="ri-medal-line"></i> Khách hàng thân thiết! Đã mua: <strong>${purchaseCount}</strong> lần.`;
                purchaseInfoDiv.style.display = 'block';

            } else {
                nameInput.value = '';
                nameInput.readOnly = false;
                // Nếu không tìm thấy khách, đảm bảo ô thông tin bị ẩn
                purchaseInfoDiv.style.display = 'none';
            }
        }
    });

    document.getElementById('sales-category-select').addEventListener('change', (e) => { populateSalesProductDropdown(e.target.value); });
    function populateSalesProductDropdown(categoryName) {
        const select = document.getElementById('sales-product-select');
        let productsToList = allProductsCache.filter(p => p.inventory > 0);
        if(categoryName) { productsToList = productsToList.filter(p => p.category === categoryName); }
        select.innerHTML = '<option value="">-- Chọn sản phẩm --</option>' + productsToList.map(p => `<option value="${p.id}">${p.name} (Tồn: ${p.inventory})</option>`).join('');
    }
    document.getElementById('sales-product-select').addEventListener('change', () => {
        const productId = document.getElementById('sales-product-select').value;
        const infoDiv = document.getElementById('sales-product-info');
        if (!productId) { infoDiv.style.display = 'none'; return; }
        const product = allProductsCache.find(p => p.id === productId);
        document.getElementById('sales-inventory-stock').textContent = product.inventory;
        document.getElementById('sales-price').textContent = formatCurrency(product.sellPrice);
        infoDiv.style.display = 'block';
    });
    document.getElementById('add-to-cart-btn').addEventListener('click', () => {
        const productId = document.getElementById('sales-product-select').value; if (!productId) return;
        const product = allProductsCache.find(p => p.id === productId);
        const existingItem = currentOrderItems.find(item => item.id === productId);
        const quantityInCart = existingItem ? existingItem.quantity : 0;
        if (quantityInCart >= product.inventory) { showToast(`Sản phẩm ${product.name} chỉ còn ${product.inventory} trong kho.`, 'warning'); return; }
        if (existingItem) { existingItem.quantity++; existingItem.subtotal = existingItem.quantity * existingItem.sellPrice; } 
        else { currentOrderItems.push({ ...product, quantity: 1, subtotal: product.sellPrice }); }
        renderSalesCart();
    });
    function renderSalesCart() {
        const tableBody = document.getElementById('sales-cart-items'); let total = 0;
        tableBody.innerHTML = currentOrderItems.map((item, index) => {
            total += item.subtotal;
            return `<tr><td>${item.name}</td><td><div class="cart-item-actions"><button type="button" onclick="updateCartQuantity(${index}, -1)">-</button><span>${item.quantity}</span><button type="button" onclick="updateCartQuantity(${index}, 1)">+</button></div></td><td>${formatCurrency(item.sellPrice)}</td><td>${formatCurrency(item.subtotal)}</td><td><button type="button" onclick="removeFromCart(${index})" style="background-color:var(--danger-color); padding:5px 10px; width:auto;"><i class="ri-delete-bin-line"></i></button></td></tr>`;
        }).join('');
        document.getElementById('sales-total').textContent = formatCurrency(total);
    }
    window.updateCartQuantity = (index, change) => {
        const item = currentOrderItems[index]; const product = allProductsCache.find(p => p.id === item.id); const newQuantity = item.quantity + change;
        if (newQuantity <= 0) { removeFromCart(index); return; }
        if (newQuantity > product.inventory) { showToast(`Sản phẩm ${product.name} chỉ còn ${product.inventory} trong kho.`, 'warning'); return; }
        item.quantity = newQuantity; item.subtotal = item.quantity * item.sellPrice; renderSalesCart();
    };
    window.removeFromCart = (index) => { currentOrderItems.splice(index, 1); renderSalesCart(); };
    document.getElementById('sales-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (currentOrderItems.length === 0) { showToast("Đơn hàng đang trống.", "error"); return; }
        const staffId = document.getElementById('sales-staff').value; if (!staffId) { showToast("Vui lòng chọn nhân viên.", "error"); return; }
        tempOrderData = { customerPhone: document.getElementById('customer-phone').value.trim(), customerName: document.getElementById('customer-name').value.trim(), staffId: staffId, items: [...currentOrderItems] };
        const paymentMethod = document.getElementById('payment-method').value;
        if (paymentMethod === 'Chuyển khoản') {
            if (!paymentInfoCache) { showToast("Chưa cấu hình thông tin thanh toán.", "error"); return; }
            let totalRevenue = tempOrderData.items.reduce((sum, item) => sum + item.subtotal, 0);
            const transactionId = `DH${Date.now()}`; tempOrderData.transactionId = transactionId;
            displayVietQR(totalRevenue, transactionId);
        } else { showLoader("Đang xử lý đơn hàng..."); await finalizeOrder(); }
    });
    document.getElementById('confirm-payment-btn').addEventListener('click', async () => { showLoader("Đang hoàn tất đơn hàng..."); await finalizeOrder(); });
    async function finalizeOrder() {
        if (!tempOrderData) return;
        try {
            const { customerPhone, customerName } = tempOrderData;
            // Chỉ thêm khách hàng mới nếu SĐT và Tên đều có và chưa tồn tại
            if (customerPhone && customerName) {
                const existingCustomer = allCustomersCache.find(c => c.phone === customerPhone);
                if (!existingCustomer) { 
                    await db.collection('customers').add({ name: customerName, phone: customerPhone }); 
                }
            }
            const staff = allStaffCache.find(s => s.id === tempOrderData.staffId);
            let totalRevenue = 0, totalCost = 0;
            tempOrderData.items.forEach(item => { totalRevenue += item.subtotal; totalCost += item.quantity * item.importPrice; });
            let totalProfit = totalRevenue - totalCost;
            const batch = db.batch();
            tempOrderData.items.forEach(item => { const productRef = db.collection('products').doc(item.id); batch.update(productRef, { inventory: firebase.firestore.FieldValue.increment(-item.quantity) }); });
            await batch.commit();
            const transactionItems = tempOrderData.items.map(item => ({ productId: item.id, name: item.name, quantity: item.quantity, sellPrice: item.sellPrice, importPrice: item.importPrice }));
            const transactionId = tempOrderData.transactionId || `DH${Date.now()}`;
            await createTransaction('export', transactionItems, totalRevenue, totalCost, totalProfit, staff.name, customerName, transactionId, customerPhone);
            tempOrderData = null;
            closeAllModals();
            showToast('Tạo đơn hàng thành công!', 'success');
            await loadInitialData();
        } catch(error) { showToast("Lỗi khi hoàn tất đơn hàng: " + error.message, 'error'); } 
        finally { hideLoader(); }
    }
    function displayVietQR(amount, orderId) {
        const { bankBin, accountNumber, beneficiaryName } = paymentInfoCache;
        const addInfo = `TT_${orderId}`;
        const qrUrl = `https://img.vietqr.io/image/${bankBin}-${accountNumber}-compact2.jpg?amount=${amount}&addInfo=${encodeURIComponent(addInfo)}&accountName=${encodeURIComponent(beneficiaryName)}`;
        document.getElementById('qr-code-image').src = qrUrl;
        document.getElementById('qr-content').textContent = addInfo;
        closeModal('sales-modal');
        openModal('qr-confirm-modal');
    }

    // ** Transaction History (Tabbed) **
    function renderHistoryTables(searchTerm = '') {
        const term = searchTerm.toLowerCase();
        const exportHistory = [], importHistory = [];
        allTransactionsCache.forEach(t => {
            const matchesSearch = !term || (t.staffName && t.staffName.toLowerCase().includes(term)) || (t.customerName && t.customerName.toLowerCase().includes(term)) || (t.customerPhone && t.customerPhone.includes(term)) || (t.transactionId && t.transactionId.toLowerCase().includes(term)) || (t.items && Array.isArray(t.items) && t.items.some(item => item.name.toLowerCase().includes(term)));
            if(matchesSearch){ if (t.type === 'export') exportHistory.push(t); else if (t.type === 'import') importHistory.push(t); }
        });
        const exportBody = document.getElementById('export-history-table');
        exportBody.innerHTML = exportHistory.map(t => { const date = t.timestamp ? t.timestamp.toDate().toLocaleString('vi-VN') : 'N/A'; const itemsDetails = (t.items && Array.isArray(t.items)) ? t.items.map(item => `<li>${item.name} (SL: ${item.quantity})</li>`).join('') : ''; return `<tr><td>${date}</td><td>${t.transactionId || 'N/A'}</td><td><ul style="margin:0; padding-left:15px;">${itemsDetails}</ul></td><td>${t.staffName || 'N/A'}</td><td>${t.customerName || 'N/A'} (${t.customerPhone || 'N/A'})</td><td>${formatCurrency(t.totalRevenue)}</td></tr>`; }).join('');
        const importBody = document.getElementById('import-history-table');
        importBody.innerHTML = importHistory.map(t => { const date = t.timestamp ? t.timestamp.toDate().toLocaleString('vi-VN') : 'N/A'; const itemsDetails = (t.items && Array.isArray(t.items)) ? t.items.map(item => `<li>${item.name} (SL: ${item.quantity})</li>`).join('') : ''; return `<tr><td>${date}</td><td><ul style="margin:0; padding-left:15px;">${itemsDetails}</ul></td><td>${formatCurrency(t.totalCost)}</td></tr>`; }).join('');
    }
    document.getElementById('history-search-input').addEventListener('input', e => renderHistoryTables(e.target.value));

    // ** Staff Report & Commission **
    function renderStaffReport() {
        const now = new Date(); const dayOfWeek = now.getDay(); const startOfWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1)); const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const report = {}; allStaffCache.forEach(s => { report[s.name] = { orders: 0, ordersWeek: 0, ordersMonth: 0, revenue: 0, profit: 0, commissionRate: s.commissionRate || 0 }; });
        allTransactionsCache.forEach(t => {
            if (t.type === 'export' && t.staffName && report[t.staffName]) {
                const tDate = t.timestamp ? t.timestamp.toDate() : null;
                report[t.staffName].orders++; report[t.staffName].revenue += t.totalRevenue || 0; report[t.staffName].profit += t.totalProfit || 0;
                if(tDate) { if (tDate >= startOfWeek) report[t.staffName].ordersWeek++; if (tDate >= startOfMonth) report[t.staffName].ordersMonth++; }
            }
        });
        const tableBody = document.getElementById('staff-report-table');
        tableBody.innerHTML = Object.keys(report).sort().map(staffName => {
            const data = report[staffName]; const commission = data.revenue * (data.commissionRate / 100);
            return `<tr><td>${staffName}</td><td>${data.orders}</td><td>${data.ordersWeek}</td><td>${data.ordersMonth}</td><td>${formatCurrency(data.revenue)}</td><td>${formatCurrency(data.profit)}</td><td>${data.commissionRate}%</td><td><strong>${formatCurrency(commission)}</strong></td></tr>`;
        }).join('');
    }

    // ** Revenue Report by Date Range **
    document.getElementById('revenue-report-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const startDate = new Date(document.getElementById('start-date').value); const endDate = new Date(document.getElementById('end-date').value);
        if (endDate < startDate) { showToast("Ngày kết thúc không thể trước ngày bắt đầu.", 'error'); return; }
        startDate.setHours(0, 0, 0, 0); endDate.setHours(23, 59, 59, 999);
        const filtered = allTransactionsCache.filter(t => { if(!t.timestamp) return false; const tDate = t.timestamp.toDate(); return t.type === 'export' && tDate >= startDate && tDate <= endDate; });
        let totalRevenue = 0, totalProfit = 0, orderCount = filtered.length;
        filtered.forEach(t => { totalRevenue += t.totalRevenue || 0; totalProfit += t.totalProfit || 0; });
        document.getElementById('report-results').innerHTML = `<h3>Kết quả từ ${startDate.toLocaleDateString('vi-VN')} đến ${endDate.toLocaleDateString('vi-VN')}</h3><div class="stats-grid"><div class="stat-item stat-revenue"><p>Tổng Doanh thu</p><strong>${formatCurrency(totalRevenue)}</strong></div><div class="stat-item stat-profit"><p>Tổng Lợi nhuận</p><strong>${formatCurrency(totalProfit)}</strong></div><div class="stat-item stat-info"><p>Tổng số đơn hàng</p><strong>${orderCount}</strong></div></div>`;
    });

    // ** Reset Data **
    document.getElementById('reset-data-btn').addEventListener('click', () => {
        const confirmation = prompt('Đây là hành động cực kỳ nguy hiểm.\nĐể xác nhận, nhập chính xác: "XÓA DỮ LIỆU"');
        if (confirmation === 'XÓA DỮ LIỆU') { if(confirm('CẢNH BÁO CUỐI CÙNG: Bạn có chắc chắn muốn xóa TOÀN BỘ dữ liệu không?')) { resetAllData(); } } 
        else if (confirmation !== null) { showToast('Chuỗi xác nhận không chính xác. Đã hủy.', 'warning'); }
    });
    async function resetAllData() {
        showLoader("Đang xóa toàn bộ dữ liệu...");
        try {
            const collections = ['products', 'transactions', 'categories', 'staff', 'customers'];
            for (const collectionName of collections) { const snapshot = await db.collection(collectionName).get(); const batch = db.batch(); snapshot.docs.forEach(doc => batch.delete(doc.ref)); await batch.commit(); }
            await db.collection('settings').doc('paymentInfo').delete();
            showModalAlert('Đã xóa toàn bộ dữ liệu thành công!', loadInitialData);
        } catch (error) { hideLoader(); showModalAlert('Đã xảy ra lỗi: ' + error.message); }
    }

    // --- 7. UTILITY & DROPDOWN FUNCTIONS ---
    async function createTransaction(type, items, totalRevenue, totalCost, totalProfit, staffName = '', customerName = '', transactionId = '', customerPhone = '') {
        const transactionData = { type, items, totalRevenue, totalCost, totalProfit, staffName, customerName, transactionId, customerPhone, timestamp: firebase.firestore.FieldValue.serverTimestamp() };
        await db.collection('transactions').add(transactionData);
    }
    function populateCategoryDropdown(selectElementId, includeAllOption = false, selectedValue = '') {
        const selectEl = document.getElementById(selectElementId);
        let options = allCategoriesCache.map(c => `<option value="${c.name}" ${c.name === selectedValue ? 'selected' : ''}>${c.name}</option>`).join('');
        if(includeAllOption) { selectEl.innerHTML = '<option value="">-- Tất cả danh mục --</option>' + options; } 
        else { selectEl.innerHTML = '<option value="" disabled>-- Chọn danh mục --</option>' + options; }
        if(!selectedValue && !includeAllOption) { selectEl.selectedIndex = 0; } 
        else if (selectedValue) { selectEl.value = selectedValue; }
    }
    function populateStaffDropdown(selectElementId) {
        const selectEl = document.getElementById(selectElementId);
        selectEl.innerHTML = '<option value="" disabled selected>-- Chọn nhân viên --</option>' + allStaffCache.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
    }

    // --- 8. GLOBAL EVENT LISTENERS & INITIAL CALLS ---
    function setupModalClosers() {
        document.querySelectorAll('.modal .close').forEach(el => { el.onclick = () => { closeModal(el.closest('.modal').id); }; });
        window.onclick = (event) => { if (event.target.classList.contains('modal')) { if(event.target.id !== 'qr-confirm-modal') { closeModal(event.target.id); } } };
    }
    setupModalClosers();
    fetchBankList();
</script>

</body>
</html>


